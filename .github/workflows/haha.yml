name: Build_oneplus_sm8750 (main.binå†…éƒ¨è°ƒè¯•ç‰ˆ)
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "ğŸ“è¯·é€‰æ‹©è¦ç¼–è¯‘çš„æœºå‹ï¼š"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_13'

      # å…¶ä»–è¾“å…¥å‚æ•°ä¿æŒä¸å˜...
      keep_original_settings:
        description: "ğŸ“ä¿æŒåŸå†…æ ¸åç§°åŠæ„å»ºæ—¶é—´"
        required: false
        default: true
        type: boolean
      # ...çœç•¥å…¶ä»–å‚æ•°

jobs:
  build_with_command_monitor:
    runs-on: ubuntu-latest
    steps:
      # çœç•¥å‰é¢ç›¸åŒæ­¥éª¤ï¼ˆä¾èµ–å®‰è£…ã€repoåŒæ­¥ç­‰ï¼‰

      - name: ğŸ”§ Set gki_defconfigï¼ˆmain.binå†…éƒ¨è°ƒè¯•ï¼‰
        env:
          ENABLE_B: ${{ github.event.inputs.enable_feature_b }}       
        run: |
          cd kernel_workspace/kernel_platform
          
          # 1. éªŒè¯æ ¸å¿ƒæ–‡ä»¶å†…å®¹å®Œæ•´æ€§
          GKI_CONFIG_PATH="./common/arch/arm64/configs/gki_defconfig"
          echo "ğŸ” éªŒè¯gki_defconfigå†…å®¹..."
          # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆé…ç½®æ–‡ä»¶ï¼ˆåŒ…å«CONFIG_å‰ç¼€ï¼‰
          if ! grep -q "^CONFIG_" "$GKI_CONFIG_PATH"; then
            echo "::error ::gki_defconfigå†…å®¹æ— æ•ˆï¼Œæœªæ‰¾åˆ°CONFIG_æ¡ç›®"
            exit 1
          fi
          # å¤‡ä»½å®Œæ•´æ–‡ä»¶å†…å®¹ç”¨äºå¯¹æ¯”
          cat "$GKI_CONFIG_PATH" > "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‰_gki_defconfigå®Œæ•´å†…å®¹.log"
          
          # 2. æ·±åº¦è§£æmain.binç±»å‹åŠå†…å®¹ï¼ˆå…³é”®æ–°å¢ï¼‰
          echo "ğŸ” è§£æmain.binç±»å‹åŠå†…å®¹..."
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ./
          # æ£€æŸ¥æ˜¯å¦ä¸ºè„šæœ¬æ–‡ä»¶ï¼ˆå¯ç›´æ¥æŸ¥çœ‹æºç ï¼‰
          if head -n 1 main.bin | grep -q -E "^#!\/bin\/(bash|sh|python)"; then
            echo "âœ… main.binæ˜¯è„šæœ¬æ–‡ä»¶ï¼Œä¿å­˜å†…å®¹ç”¨äºåˆ†æ..."
            cat main.bin > "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/main.bin_è„šæœ¬æºç .log"
            # æ£€æŸ¥è„šæœ¬è¯­æ³•é”™è¯¯
            if head -n 1 main.bin | grep -q "bash"; then
              echo "ğŸ” æ£€æŸ¥bashè„šæœ¬è¯­æ³•..."
              bash -n main.bin 2> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/main.bin_è¯­æ³•æ£€æŸ¥.log"
              if [ $? -ne 0 ]; then
                echo "::error ::main.binè„šæœ¬å­˜åœ¨è¯­æ³•é”™è¯¯"
                cat "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/main.bin_è¯­æ³•æ£€æŸ¥.log"
                exit 1
              fi
            fi
          else
            # äºŒè¿›åˆ¶æ–‡ä»¶å¤„ç†
            echo "âœ… main.binæ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåˆ†ææ‰§è¡Œç‰¹å¾..."
            # æ£€æŸ¥æ˜¯å¦ä¸ºé™æ€é“¾æ¥ï¼ˆåŠ¨æ€é“¾æ¥å¯èƒ½ç¼ºåº“ï¼‰
            if ldd main.bin 2>&1 | grep -q "not a dynamic executable"; then
              echo "ğŸ“Œ main.binæ˜¯é™æ€é“¾æ¥äºŒè¿›åˆ¶"
            else
              echo "ğŸ“Œ main.binåŠ¨æ€ä¾èµ–ï¼š"
              ldd main.bin | tee "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/main.bin_åŠ¨æ€ä¾èµ–.log"
            fi
          fi
          
          # 3. æ‰§è¡Œç¯å¢ƒå…¨æ™¯æ£€æŸ¥ï¼ˆæ–°å¢ï¼‰
          echo "ğŸ” æ‰§è¡Œç¯å¢ƒå…¨æ™¯æ£€æŸ¥..."
          # æ£€æŸ¥å½“å‰ç”¨æˆ·æƒé™
          echo "å½“å‰ç”¨æˆ·ï¼š$(whoami)ï¼ŒUID: $(id -u)ï¼ŒGID: $(id -g)" >> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/ç¯å¢ƒæ£€æŸ¥.log"
          # æ£€æŸ¥å·¥ä½œç›®å½•æƒé™
          ls -ld . >> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/ç¯å¢ƒæ£€æŸ¥.log"
          # æ£€æŸ¥å…³é”®ç›®å½•å¯å†™æ€§
          for dir in ./ ./common ./common/arch/arm64/configs; do
            touch "$dir/_test_write_permission" 2>> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/ç¯å¢ƒæ£€æŸ¥.log"
            if [ $? -ne 0 ]; then
              echo "::error ::ç›®å½•ä¸å¯å†™ï¼š$dir"
              exit 1
            fi
            rm -f "$dir/_test_write_permission"
          done
          
          # 4. æ‰§è¡Œmain.binå¹¶æ•è·æè‡´ç»†èŠ‚
          echo "â–¶ï¸ æ‰§è¡Œmain.binï¼ˆå¸¦æŒ‡ä»¤çº§è·Ÿè¸ªï¼‰..."
          # å¯¼å‡ºæ‰€æœ‰ç¯å¢ƒå˜é‡ä¾›main.binä½¿ç”¨
          export > "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œæ—¶ç¯å¢ƒå˜é‡å…¨é‡.log"
          
          # ä½¿ç”¨straceæ•è·æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ï¼ŒåŒ…æ‹¬ä¿¡å·å’Œè¿›ç¨‹çŠ¶æ€
          sudo -E strace -f -tt -v -s 8192 \
            -e trace=all \
            -o "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/straceå…¨é‡è·Ÿè¸ª.log" \
            ./main.bin "setup_gki_config" "$ENABLE_B" \
            1> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/stdout.log" \
            2> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/stderr.log"
          
          # 5. æ•è·é€€å‡ºç å¹¶å¼ºåˆ¶åˆ†æ
          MAIN_GKI_EXIT_CODE=$?
          echo "é€€å‡ºç ï¼š$MAIN_GKI_EXIT_CODE" >> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œä¿¡æ¯.txt"
          
          # 6. æ‰§è¡Œåæ–‡ä»¶çŠ¶æ€æ£€æŸ¥
          echo "ğŸ“¥ å¤‡ä»½æ‰§è¡ŒåçŠ¶æ€..."
          [ -f "$GKI_CONFIG_PATH" ] && cat "$GKI_CONFIG_PATH" > "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå_gki_defconfigå®Œæ•´å†…å®¹.log"
          
          # 7. å¤±è´¥æ—¶å¼ºåˆ¶æš´éœ²å…³é”®çº¿ç´¢
          if [ $MAIN_GKI_EXIT_CODE -ne 0 ]; then
            echo "::error ::main.binæ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç =$MAIN_GKI_EXIT_CODE"
            echo "========================================"
            echo "ğŸš¨ é”™è¯¯è¾“å‡ºï¼ˆå®Œæ•´ï¼‰ï¼š"
            cat "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/stderr.log"
            echo "========================================"
            echo "ğŸ” æœ€å10ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š"
            grep -E "exit_group|write|openat|execve" "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/straceå…¨é‡è·Ÿè¸ª.log" | tail -n 10
            echo "========================================"
            exit $MAIN_GKI_EXIT_CODE
          fi
          
          rm -rf ./main.bin
          echo "âœ… main.binæ‰§è¡ŒæˆåŠŸ"

      # çœç•¥åç»­æ­¥éª¤...

      - name: ğŸ“¤ ä¸Šä¼ å‘½ä»¤ç›‘æ§æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: å‘½ä»¤ç›‘æ§æ—¥å¿—_${{ env.DEVICES_NAME }}
          path: ${{ env.MONITOR_DIR }}
          retention-days: 14
