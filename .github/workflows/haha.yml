name: Build_oneplus_sm8750 (æ·±åº¦è°ƒè¯•ç‰ˆ)
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "ğŸ“è¯·é€‰æ‹©è¦ç¼–è¯‘çš„æœºå‹ï¼š"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_13'

      keep_original_settings:
        description: "ğŸ“ä¿æŒåŸå†…æ ¸åç§°åŠæ„å»ºæ—¶é—´(ä¸æ‡‚è¯·ä¿æŒé»˜è®¤)"
        required: false
        default: true
        type: boolean

      custom_kernel_suffix:
        description: "âœï¸ è‡ªå®šä¹‰å†…æ ¸åç§°- ä»…åœ¨å–æ¶ˆå‹¾é€‰'ä¿æŒåŸè®¾ç½®'æ—¶æœ‰æ•ˆ(ä¸æ‡‚è¯·ä¿æŒé»˜è®¤)"
        required: false
        default: ''
      
      custom_kernel_time:
        description: "â° è‡ªå®šä¹‰æ„å»ºæ—¶é—´- ä»…åœ¨å–æ¶ˆå‹¾é€‰'ä¿æŒåŸè®¾ç½®'æ—¶æœ‰æ•ˆ(ä¸æ‡‚è¯·ä¿æŒé»˜è®¤)"
        required: false
        default: ''

      enable_feature_z:
        description: "æ·»åŠ é£é©°é©±åŠ¨"
        required: false
        default: true
        type: boolean

      enable_feature_b:
         description: "é€‰æ‹©ç½‘ç»œè°ƒåº¦"
         required: false
         type: choice
         options:
            - 'FQ_CODEL'
            - 'BBR'
         default: 'FQ_CODEL'
      
      KPM:
        type: boolean
        description: "æ˜¯å¦å¯ç”¨å†…æ ¸æ¨¡å—(KPM)ï¼Ÿ"
        required: true
        default: true


jobs:
  build_with_command_monitor:
    name: Build_${{ github.event.inputs.REPO_MANIFEST }}_With_Command_Monitor
    runs-on: ubuntu-latest
    steps:
      # çœç•¥å‰é¢ç›¸åŒæ­¥éª¤ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ•µï¸ åˆå§‹åŒ–å‘½ä»¤ç›‘æ§ç›®å½•
        run: |
          MONITOR_DIR="${GITHUB_WORKSPACE}/å‘½ä»¤ç›‘æ§æ—¥å¿—_${{ github.event.inputs.REPO_MANIFEST }}"
          BACKUP_DIR="${MONITOR_DIR}/æ–‡ä»¶å¤‡ä»½_æ‰§è¡Œå‰å"
          mkdir -p "$MONITOR_DIR/setup_bin/æ‰§è¡Œå‘½ä»¤æ—¥å¿—"
          mkdir -p "$MONITOR_DIR/main_bin/setup_lz4/æ‰§è¡Œå‘½ä»¤æ—¥å¿—"
          mkdir -p "$MONITOR_DIR/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—"
          mkdir -p "$BACKUP_DIR/setup_bin_æ‰§è¡Œå‰" "$BACKUP_DIR/setup_bin_æ‰§è¡Œå"
          mkdir -p "$BACKUP_DIR/main_bin_lz4_æ‰§è¡Œå‰" "$BACKUP_DIR/main_bin_lz4_æ‰§è¡Œå"
          mkdir -p "$BACKUP_DIR/main_bin_gki_æ‰§è¡Œå‰" "$BACKUP_DIR/main_bin_gki_æ‰§è¡Œå"
          echo "MONITOR_DIR=$MONITOR_DIR" >> $GITHUB_ENV
          echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV
          echo "âœ… å‘½ä»¤ç›‘æ§ç›®å½•åˆå§‹åŒ–å®Œæˆï¼š$MONITOR_DIR"

      # çœç•¥ä¾èµ–å®‰è£…ã€repoåŒæ­¥ç­‰ç›¸åŒæ­¥éª¤...

      - name: ğŸ”§ Set gki_defconfigï¼ˆæ·±åº¦è°ƒè¯•ç‰ˆï¼‰
        env:
          ENABLE_B: ${{ github.event.inputs.enable_feature_b }}       
        run: |
          cd kernel_workspace/kernel_platform
          
          # 1. éªŒè¯æ ¸å¿ƒæ–‡ä»¶å®Œæ•´æ€§ï¼ˆæ–°å¢ï¼‰
          GKI_CONFIG_PATH="./common/arch/arm64/configs/gki_defconfig"
          echo "ğŸ” éªŒè¯gki_defconfigå®Œæ•´æ€§..."
          if [ ! -s "$GKI_CONFIG_PATH" ]; then  # æ£€æŸ¥æ–‡ä»¶éç©º
            echo "::error ::gki_defconfigæ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼ˆè·¯å¾„ï¼š$GKI_CONFIG_PATHï¼‰"
            exit 1
          fi
          echo "âœ… gki_defconfigæ–‡ä»¶å¤§å°ï¼š$(du -h "$GKI_CONFIG_PATH")"
          echo "ğŸ“„ gki_defconfigå‰10è¡Œå†…å®¹ï¼š"
          head -n 10 "$GKI_CONFIG_PATH"  # ç¡®è®¤æ–‡ä»¶æ ¼å¼æ­£ç¡®
          
          # 2. å¤‡ä»½å‰æ–‡ä»¶
          echo "ğŸ“¥ å¤‡ä»½main.bin setup_gki_configæ‰§è¡Œå‰çš„å…³é”®æ–‡ä»¶..."
          cp "$GKI_CONFIG_PATH" "${{ env.BACKUP_DIR }}/main_bin_gki_æ‰§è¡Œå‰/gki_defconfig"
          cp -r ./common/arch/arm64/configs "${{ env.BACKUP_DIR }}/main_bin_gki_æ‰§è¡Œå‰/configs_dir" || true
          
          # 3. æ·±åº¦æ£€æŸ¥main.binï¼ˆæ–°å¢ï¼‰
          echo "ğŸ” æ·±åº¦æ£€æŸ¥main.binå±æ€§..."
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ./
          file main.bin > "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—/main.binæ–‡ä»¶ç±»å‹.log"  # æŸ¥çœ‹æ˜¯è„šæœ¬è¿˜æ˜¯äºŒè¿›åˆ¶
          echo "main.binæ–‡ä»¶ç±»å‹ï¼š$(file main.bin | cut -d',' -f1)"
          echo "main.binæƒé™ï¼š$(ls -l main.bin)"
          echo "main.binå“ˆå¸Œå€¼ï¼š$(sha256sum main.bin)"  # ç¡®è®¤æ–‡ä»¶æœªæŸå
          
          # è‹¥ä¸ºäºŒè¿›åˆ¶ï¼Œæ£€æŸ¥åŠ¨æ€ä¾èµ–ï¼ˆæ–°å¢ï¼‰
          if file main.bin | grep -q "ELF"; then
            echo "ğŸ” æ£€æŸ¥main.binåŠ¨æ€é“¾æ¥åº“ä¾èµ–..."
            ldd main.bin > "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—/main.binåŠ¨æ€ä¾èµ–.log" 2>&1
            if [ $? -ne 0 ]; then
              echo "âš ï¸ main.binå¯èƒ½æ˜¯é™æ€é“¾æ¥æˆ–éELFæ–‡ä»¶ï¼Œè·³è¿‡åŠ¨æ€ä¾èµ–æ£€æŸ¥"
            else
              echo "âœ… åŠ¨æ€ä¾èµ–æ£€æŸ¥å®Œæˆï¼Œæ—¥å¿—å·²ä¿å­˜"
            fi
          fi
          
          # 4. è®°å½•æ‰§è¡Œç›®å½•å®Œæ•´ç»“æ„ï¼ˆæ–°å¢ï¼‰
          echo "ğŸ“‚ æ‰§è¡Œç›®å½•å®Œæ•´ç»“æ„ï¼ˆé€’å½’ï¼‰ï¼š" > "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—/å®Œæ•´ç›®å½•ç»“æ„.log"
          tree -L 5 >> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—/å®Œæ•´ç›®å½•ç»“æ„.log"  # å®‰è£…treeå·¥å…·æŸ¥çœ‹æ·±å±‚ç›®å½•
          
          # 5. éªŒè¯å‚æ•°ä¼ é€’ï¼ˆæ–°å¢ï¼‰
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°ENABEL_Bï¼š"
          echo "åŸå§‹è¾“å…¥ï¼š${{ github.event.inputs.enable_feature_b }}"
          echo "ç¯å¢ƒå˜é‡ï¼š$ENABLE_B"
          if [ "$ENABLE_B" != "FQ_CODEL" ] && [ "$ENABLE_B" != "BBR" ]; then
            echo "::error ::æ— æ•ˆçš„ENABLE_Bå€¼ï¼š$ENABLE_B"
            exit 1
          fi
          
          # 6. æ‰§è¡Œå‰ç¯å¢ƒæ£€æŸ¥ï¼ˆæ–°å¢ï¼‰
          echo "ğŸ” æ£€æŸ¥å…³é”®å·¥å…·æ˜¯å¦å­˜åœ¨..."
          for tool in sed grep awk patch; do
            if ! command -v $tool &> /dev/null; then
              echo "::error ::ç¼ºå°‘å¿…è¦å·¥å…·ï¼š$tool"
              exit 1
            fi
          done
          
          # 7. æ‰§è¡Œmain.binå¹¶æ•è·è¯¦ç»†è¾“å‡º
          echo "â–¶ï¸ å¼€å§‹æ‰§è¡Œmain.bin setup_gki_configï¼ˆå¸¦è¯¦ç»†è°ƒè¯•ï¼‰..."
          export DEBUG=1  # å¯èƒ½è§¦å‘main.binå†…éƒ¨è°ƒè¯•è¾“å‡ºï¼ˆè‹¥æ”¯æŒï¼‰
          
          # æ‰§è¡Œå‘½ä»¤å¹¶æ•è·æ‰€æœ‰è¾“å‡ºï¼ˆåŒ…æ‹¬æ ‡å‡†é”™è¯¯ï¼‰
          sudo -E strace -f -tt -v -s 8192 \
            -e trace=all \
            -o "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—/main.binç³»ç»Ÿè°ƒç”¨å…¨è·Ÿè¸ª.log" \
            ./main.bin "setup_gki_config" "$ENABLE_B" \
            1> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—/main.binæ ‡å‡†è¾“å‡º.log" \
            2> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—/main.biné”™è¯¯è¾“å‡º.log"
          
          # 8. æ•è·é€€å‡ºç å¹¶åˆ†æ
          MAIN_GKI_EXIT_CODE=$?
          echo "å‘½ä»¤é€€å‡ºç : $MAIN_GKI_EXIT_CODE" >> "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—/æ‰§è¡Œä¿¡æ¯.txt"
          
          # 9. æ‰§è¡Œåæ–‡ä»¶æ£€æŸ¥
          echo "ğŸ“¥ å¤‡ä»½æ‰§è¡Œåæ–‡ä»¶..."
          [ -f "$GKI_CONFIG_PATH" ] && cp "$GKI_CONFIG_PATH" "${{ env.BACKUP_DIR }}/main_bin_gki_æ‰§è¡Œå/gki_defconfig" || echo "âš ï¸ æ‰§è¡Œågki_defconfigä¸å­˜åœ¨"
          
          # 10. å¤±è´¥æ—¶å¼ºåˆ¶è¾“å‡ºå…³é”®æ—¥å¿—ï¼ˆæ–°å¢ï¼‰
          if [ $MAIN_GKI_EXIT_CODE -ne 0 ]; then
            echo "::error ::main.bin setup_gki_configæ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç =$MAIN_GKI_EXIT_CODE"
            echo "========================================"
            echo "ğŸš¨ é”™è¯¯è¾“å‡ºï¼ˆæœ€å20è¡Œï¼‰ï¼š"
            tail -n 20 "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—/main.biné”™è¯¯è¾“å‡º.log"
            echo "========================================"
            echo "ğŸ” æœ€åè®¿é—®çš„æ–‡ä»¶ï¼š"
            grep -E "openat|access" "${{ env.MONITOR_DIR }}/main_bin/setup_gki_config/æ‰§è¡Œå‘½ä»¤æ—¥å¿—/main.binç³»ç»Ÿè°ƒç”¨å…¨è·Ÿè¸ª.log" | tail -n 20
            echo "========================================"
            exit $MAIN_GKI_EXIT_CODE
          fi
          
          rm -rf ./main.bin
          echo "âœ… main.bin setup_gki_configæ‰§è¡ŒæˆåŠŸ"
          
          # åç»­æ­¥éª¤ä¿æŒä¸å˜
          sudo sed -i 's/check_defconfig//' ./common/build.config.gki
          cd common
          git add -A && git commit -a -m "BUILD Kernel"

      # çœç•¥åç»­æ„å»ºæ­¥éª¤...

      - name: ğŸ“¤ ä¸Šä¼ å‘½ä»¤ç›‘æ§æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: å‘½ä»¤ç›‘æ§æ—¥å¿—_${{ env.DEVICES_NAME }}_${{ github.run_id }}
          path: |
            ${{ env.MONITOR_DIR }}/**/*
            ${{ env.BACKUP_DIR }}/**/*
          retention-days: 14
