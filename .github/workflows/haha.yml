name: é€†å‘åŠ å¯†æ–‡ä»¶ (main.bin/setup.bin)
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "ğŸ“é€‰æ‹©æœºå‹ï¼ˆä¸åŸç¼–è¯‘æœºå‹ä¸€è‡´ï¼‰"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_13'
      BIN_PATH:
        description: "ğŸ”‘åŠ å¯†æ–‡ä»¶å­˜æ”¾è·¯å¾„ï¼ˆGitHubä»“åº“å†…è·¯å¾„ï¼Œå¦‚ï¼š.github/workflows/Binï¼‰"
        required: true
        default: ".github/workflows/Bin"


jobs:
  reverse:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»“åº“ï¼ˆéœ€åŒ…å«åŠ å¯†æ–‡ä»¶main.bin/setup.binï¼‰
      - name: ğŸ“¥ æ£€å‡ºä»“åº“ï¼ˆå«åŠ å¯†æ–‡ä»¶ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. åˆå§‹åŒ–é€†å‘ç»“æœç›®å½•ï¼ˆæ‰€æœ‰é€†å‘æ–‡ä»¶å°†å­˜è¿™é‡Œï¼Œæœ€åå¯ä¸‹è½½ï¼‰
      - name: ğŸ“‚ åˆ›å»ºé€†å‘ç»“æœç›®å½•
        run: |
          REVERSE_DIR="${GITHUB_WORKSPACE}/é€†å‘ç»“æœ_${{ env.DEVICES_NAME }}"
          mkdir -p "$REVERSE_DIR" \
            "$REVERSE_DIR/setup_bin_é€†å‘" \
            "$REVERSE_DIR/main_bin_é€†å‘" \
            "$REVERSE_DIR/åŸå§‹å¤‡ä»½" \
            "$REVERSE_DIR/æ“ä½œæ—¥å¿—"
          echo "REVERSE_DIR=$REVERSE_DIR" >> $GITHUB_ENV
          echo "âœ… é€†å‘ç»“æœç›®å½•åˆ›å»ºå®Œæˆï¼š$REVERSE_DIR"

      # 3. å®‰è£…ä¾èµ–ï¼ˆå«straceï¼Œç”¨äºè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ï¼‰
      - name: ğŸ›  å®‰è£…é€†å‘å·¥å…·
        run: |
          sudo apt update -qq
          sudo apt install -y strace diffutils tree  # straceè·Ÿè¸ªè°ƒç”¨ï¼Œdiffå¯¹æ¯”æ–‡ä»¶ï¼Œtreeç”Ÿæˆç›®å½•ç»“æ„
          # è®°å½•å·¥å…·ç‰ˆæœ¬ï¼ˆç”¨äºæ—¥å¿—ï¼‰
          strace --version | head -n1 > "${{ env.REVERSE_DIR }}/æ“ä½œæ—¥å¿—/å·¥å…·ç‰ˆæœ¬.txt"
          diff --version | head -n1 >> "${{ env.REVERSE_DIR }}/æ“ä½œæ—¥å¿—/å·¥å…·ç‰ˆæœ¬.txt"

      # 4. è®¾ç½®æœºå‹ç¯å¢ƒå˜é‡
      - name: âš™ï¸ é…ç½®æœºå‹å˜é‡
        run: |
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_ace5_pro)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_ace5_pro_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_ace5_pro" >> $GITHUB_ENV
              ;;
            oneplus_13)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_13_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_13" >> $GITHUB_ENV
              ;;
            *)
              echo "REPO_MANIFEST=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              echo "DEVICES_NAME=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              ;;
          esac

      # 5. åŒæ­¥å†…æ ¸æºç ï¼ˆä¸åŸç¼–è¯‘æµç¨‹ä¸€è‡´ï¼Œç¡®ä¿ç¯å¢ƒç›¸åŒï¼‰
      - name: ğŸ“¥ åŒæ­¥å†…æ ¸æºç ï¼ˆé€†å‘åŸºç¡€ç¯å¢ƒï¼‰
        run: |
          mkdir -p kernel_workspace && cd kernel_workspace
          # è®°å½•åŒæ­¥æ—¥å¿—
          repo init -u https://github.com/showdo/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m ${REPO_MANIFEST}.xml --depth=1 2>&1 | tee "${{ env.REVERSE_DIR }}/æ“ä½œæ—¥å¿—/repo_init.log"
          repo sync -c -j$(nproc --all) --no-tags 2>&1 | tee "${{ env.REVERSE_DIR }}/æ“ä½œæ—¥å¿—/repo_sync.log"
          # å¤‡ä»½åŒæ­¥åçš„å®Œæ•´ç¯å¢ƒï¼ˆç”¨äºåç»­å¯¹æ¯”ï¼‰
          cp -r kernel_platform "${{ env.REVERSE_DIR }}/åŸå§‹å¤‡ä»½/åŒæ­¥å_kernel_platform"
          echo "âœ… å†…æ ¸æºç åŒæ­¥å®Œæˆï¼ŒåŸå§‹ç¯å¢ƒå·²å¤‡ä»½"

      # 6. é€†å‘ setup.binï¼ˆç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œå‰å¤‡ä»½ï¼‰
      - name: ğŸ” é€†å‘setup.bin - æ‰§è¡Œå‰å¤‡ä»½
        run: |
          # è¿›å…¥setup.binè¦æ‰§è¡Œçš„ç›®å½•ï¼ˆKernelSUç›®å½•ï¼‰
          cd kernel_workspace/kernel_platform
          # å…ˆæ‰§è¡ŒSuKiSUçš„setup.shï¼ˆä¸åŸæµç¨‹ä¸€è‡´ï¼Œç¡®ä¿setup.binèƒ½æ­£å¸¸è¿è¡Œï¼‰
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/setup.sh" -o setup.sh && bash setup.sh susfs-main 2>&1 | tee "${{ env.REVERSE_DIR }}/æ“ä½œæ—¥å¿—/sukisu_setup.log"
          # å¤‡ä»½KernelSUç›®å½•ï¼ˆsetup.binæ‰§è¡Œå‰çŠ¶æ€ï¼‰
          cp -r KernelSU "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå‰_KernelSU"
          # è®°å½•ç›®å½•ç»“æ„ï¼ˆæ–¹ä¾¿å¯¹æ¯”ï¼‰
          tree KernelSU -L 3 > "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå‰_KernelSU_ç›®å½•ç»“æ„.txt"
          echo "âœ… setup.binæ‰§è¡Œå‰å¤‡ä»½å®Œæˆ"

      # 7. é€†å‘ setup.binï¼ˆç¬¬äºŒæ­¥ï¼šæ‰§è¡Œå¹¶è·Ÿè¸ªï¼‰
      - name: ğŸ” é€†å‘setup.bin - æ‰§è¡Œ+è·Ÿè¸ª
        run: |
          cd kernel_workspace/kernel_platform/KernelSU
          # å¤åˆ¶åŠ å¯†æ–‡ä»¶åˆ°å½“å‰ç›®å½•ï¼ˆä»ä»“åº“æŒ‡å®šè·¯å¾„è¯»å–ï¼‰
          cp "${GITHUB_WORKSPACE}/${{ github.event.inputs.BIN_PATH }}/setup.bin" ./
          chmod +x setup.bin
          # 1. ç”¨straceè·Ÿè¸ªæ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ï¼ˆæ–‡ä»¶è¯»å†™ã€å‘½ä»¤æ‰§è¡Œï¼‰
          sudo strace -f -o "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setup.bin_strace.log" -e trace=file,execve,openat,write,unlink,chmod ./setup.bin 2>&1 | tee "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setup.bin_æ‰§è¡Œè¾“å‡º.log"
          # 2. æ‰§è¡Œåå¤‡ä»½KernelSUç›®å½•ï¼ˆè®°å½•å˜åŒ–ï¼‰
          cp -r . "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå_KernelSU"
          # 3. è®°å½•æ‰§è¡Œåç›®å½•ç»“æ„
          tree . -L 3 > "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå_KernelSU_ç›®å½•ç»“æ„.txt"
          echo "âœ… setup.binæ‰§è¡Œè·Ÿè¸ªå®Œæˆ"

      # 8. é€†å‘ setup.binï¼ˆç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆå·®å¼‚æŠ¥å‘Šï¼‰
      - name: ğŸ” é€†å‘setup.bin - ç”Ÿæˆå·®å¼‚æŠ¥å‘Š
        run: |
          # å¯¹æ¯”æ‰§è¡Œå‰åçš„æ–‡ä»¶å˜åŒ–ï¼Œç”Ÿæˆdiffè¡¥ä¸ï¼ˆæ˜¾ç¤ºå…·ä½“ä¿®æ”¹å†…å®¹ï¼‰
          diff -urN \
            "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå‰_KernelSU" \
            "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå_KernelSU" \
            > "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setup.bin_æ–‡ä»¶å˜åŒ–.diff" 2>&1 | tee "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setup.bin_diff_æ—¥å¿—.txt"
          # æå–æ–°å¢æ–‡ä»¶åˆ—è¡¨
          comm -23 \
            <(find "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå_KernelSU" -type f | sed "s|${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå_KernelSU/||") \
            <(find "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå‰_KernelSU" -type f | sed "s|${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå‰_KernelSU/||") \
            > "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setup.bin_æ–°å¢æ–‡ä»¶.txt"
          # æå–åˆ é™¤æ–‡ä»¶åˆ—è¡¨
          comm -23 \
            <(find "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå‰_KernelSU" -type f | sed "s|${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå‰_KernelSU/||") \
            <(find "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå_KernelSU" -type f | sed "s|${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setupå_KernelSU/||") \
            > "${{ env.REVERSE_DIR }}/setup_bin_é€†å‘/setup.bin_åˆ é™¤æ–‡ä»¶.txt"
          echo "âœ… setup.binå·®å¼‚æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      # 9. é€†å‘ main.binï¼ˆç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œå‰å¤‡ä»½ï¼‰
      - name: ğŸ” é€†å‘main.bin - æ‰§è¡Œå‰å¤‡ä»½
        run: |
          # è¿›å…¥main.binè¦æ‰§è¡Œçš„ç›®å½•ï¼ˆcommonç›®å½•ï¼‰
          cd kernel_workspace/kernel_platform/common
          # å¤‡ä»½LZ4ç›®å½•ï¼ˆmain.binæ‰§è¡Œå‰çŠ¶æ€ï¼‰
          cp -r lib/lz4 "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå‰_lz4"
          # è®°å½•LZ4ç›®å½•ç»“æ„
          tree lib/lz4 > "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå‰_lz4_ç›®å½•ç»“æ„.txt"
          # å¤‡ä»½å½“å‰ç›®å½•ä¸‹çš„å…¶ä»–å¯èƒ½è¢«ä¿®æ”¹çš„æ–‡ä»¶
          cp -r lib "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå‰_lib"
          echo "âœ… main.binæ‰§è¡Œå‰å¤‡ä»½å®Œæˆ"

      # 10. é€†å‘ main.binï¼ˆç¬¬äºŒæ­¥ï¼šæ‰§è¡Œå¹¶è·Ÿè¸ªï¼‰
      - name: ğŸ” é€†å‘main.bin - æ‰§è¡Œ+è·Ÿè¸ª
        run: |
          cd kernel_workspace/kernel_platform/common
          # å¤åˆ¶åŠ å¯†æ–‡ä»¶åˆ°å½“å‰ç›®å½•
          cp "${GITHUB_WORKSPACE}/${{ github.event.inputs.BIN_PATH }}/main.bin" ./
          chmod +x main.bin
          # 1. ç”¨straceè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨
          sudo strace -f -o "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/main.bin_strace.log" -e trace=file,execve,openat,write,unlink,chmod ./main.bin "setup_lz4" 2>&1 | tee "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/main.bin_æ‰§è¡Œè¾“å‡º.log"
          # 2. æ‰§è¡Œåå¤‡ä»½LZ4ç›®å½•ï¼ˆå…³é”®ï¼šæ•è·æ–°ç”Ÿæˆçš„æºç æ–‡ä»¶ï¼‰
          cp -r lib/lz4 "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå_lz4"
          # 3. è®°å½•æ‰§è¡Œåç›®å½•ç»“æ„
          tree lib/lz4 > "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå_lz4_ç›®å½•ç»“æ„.txt"
          # 4. å•ç‹¬å¤‡ä»½æ–°ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆæ–¹ä¾¿åç»­æå–æºç ï¼‰
          mkdir -p "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/main.bin_ç”Ÿæˆçš„æºç "
          cp -r lib/lz4/* "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/main.bin_ç”Ÿæˆçš„æºç /"
          echo "âœ… main.binæ‰§è¡Œè·Ÿè¸ªå®Œæˆ"

      # 11. é€†å‘ main.binï¼ˆç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆå·®å¼‚æŠ¥å‘Šï¼‰
      - name: ğŸ” é€†å‘main.bin - ç”Ÿæˆå·®å¼‚æŠ¥å‘Š
        run: |
          # å¯¹æ¯”LZ4ç›®å½•æ‰§è¡Œå‰åçš„å˜åŒ–
          diff -urN \
            "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå‰_lz4" \
            "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå_lz4" \
            > "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/main.bin_æ–‡ä»¶å˜åŒ–.diff" 2>&1 | tee "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/main.bin_diff_æ—¥å¿—.txt"
          # æå–æ–°å¢æ–‡ä»¶åˆ—è¡¨ï¼ˆå¦‚lz4.cã€lz4armv8.Sï¼‰
          comm -23 \
            <(find "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå_lz4" -type f | sed "s|${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå_lz4/||") \
            <(find "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå‰_lz4" -type f | sed "s|${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå‰_lz4/||") \
            > "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/main.bin_æ–°å¢æ–‡ä»¶.txt"
          # æå–åˆ é™¤æ–‡ä»¶åˆ—è¡¨ï¼ˆå¦‚æ—§çš„lz4_compress.cï¼‰
          comm -23 \
            <(find "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå‰_lz4" -type f | sed "s|${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå‰_lz4/||") \
            <(find "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå_lz4" -type f | sed "s|${{ env.REVERSE_DIR }}/main_bin_é€†å‘/mainå_lz4/||") \
            > "${{ env.REVERSE_DIR }}/main_bin_é€†å‘/main.bin_åˆ é™¤æ–‡ä»¶.txt"
          echo "âœ… main.binå·®å¼‚æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      # 12. æ‰“åŒ…é€†å‘ç»“æœï¼ˆæ–¹ä¾¿ä¸‹è½½ï¼‰
      - name: ğŸ“¦ æ‰“åŒ…é€†å‘ç»“æœ
        run: |
          cd "${GITHUB_WORKSPACE}"
          # ç”Ÿæˆé€†å‘è¯´æ˜æ–‡æ¡£
          cat > "${{ env.REVERSE_DIR }}/é€†å‘ç»“æœè¯´æ˜.md" << EOF
          # åŠ å¯†æ–‡ä»¶é€†å‘ç»“æœè¯´æ˜
          ## 1. ç›®å½•ç»“æ„
          - setup_bin_é€†å‘ï¼šsetup.binçš„æ‰§è¡Œæ—¥å¿—ã€å‰åå¤‡ä»½ã€æ–‡ä»¶å˜åŒ–
          - main_bin_é€†å‘ï¼šmain.binçš„æ‰§è¡Œæ—¥å¿—ã€ç”Ÿæˆçš„æºç ï¼ˆå…³é”®ï¼ï¼‰
          - åŸå§‹å¤‡ä»½ï¼šå†…æ ¸æºç åŒæ­¥åçš„åˆå§‹ç¯å¢ƒ
          - æ“ä½œæ—¥å¿—ï¼šå·¥å…·ç‰ˆæœ¬ã€repoåŒæ­¥ç­‰è¾…åŠ©æ—¥å¿—

          ## 2. æ ¸å¿ƒé€†å‘æˆæœ
          1. main.bin_ç”Ÿæˆçš„æºç ï¼šåŒ…å«main.binç”Ÿæˆçš„æ‰€æœ‰æ–°æ–‡ä»¶ï¼ˆå¦‚lz4.cã€lz4armv8.Sï¼‰
          2. *.diffæ–‡ä»¶ï¼šæ˜¾ç¤ºåŠ å¯†æ–‡ä»¶ä¿®æ”¹çš„å…·ä½“å†…å®¹ï¼ˆå¯ç›´æ¥æŸ¥çœ‹ä»£ç å˜æ›´ï¼‰
          3. strace.logï¼šè·Ÿè¸ªåŠ å¯†æ–‡ä»¶çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚æ‰“å¼€äº†å“ªäº›æ–‡ä»¶ã€æ‰§è¡Œäº†å“ªäº›å‘½ä»¤ï¼‰
          4. æ–°å¢/åˆ é™¤æ–‡ä»¶.txtï¼šæ˜ç¡®åŠ å¯†æ–‡ä»¶å¯¹æ–‡ä»¶çš„å¢åˆ æ“ä½œ

          ## 3. åç»­ä½¿ç”¨å»ºè®®
          1. ä»ã€Œmain.bin_ç”Ÿæˆçš„æºç ã€æå–æ–°æ–‡ä»¶å†…å®¹ï¼Œä½œä¸ºæ›¿ä»£è„šæœ¬çš„æ¨¡æ¿
          2. ä»ã€Œ*.diffã€æ–‡ä»¶æå–setup.binå¯¹Makefile/é…ç½®æ–‡ä»¶çš„ä¿®æ”¹é€»è¾‘
          3. ä»ã€Œstrace.logã€éªŒè¯æ˜¯å¦æœ‰éšè—æ“ä½œï¼ˆå¦‚å·å·æ‰§è¡Œå…¶ä»–å‘½ä»¤ï¼‰
          EOF
          # å‹ç¼©ç›®å½•ï¼ˆé¿å…æ–‡ä»¶è¿‡å¤šï¼‰
          zip -r "${{ env.REVERSE_DIR }}.zip" "${{ env.REVERSE_DIR }}"
          echo "âœ… é€†å‘ç»“æœæ‰“åŒ…å®Œæˆï¼š${{ env.REVERSE_DIR }}.zip"

      # 13. ä¸Šä¼ é€†å‘ç»“æœï¼ˆå…³é”®ï¼šä¸‹è½½ååˆ†æï¼‰
      - name: ğŸ“¤ ä¸Šä¼ é€†å‘ç»“æœï¼ˆå¯ä¸‹è½½ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: åŠ å¯†æ–‡ä»¶é€†å‘ç»“æœ_${{ env.DEVICES_NAME }}
          path: |
            ${{ env.REVERSE_DIR }}.zip
            ${{ env.REVERSE_DIR }}/**/*
          retention-days: 90  # ä¿ç•™90å¤©ï¼Œè¶³å¤Ÿåˆ†æ
