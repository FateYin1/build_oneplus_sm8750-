name: Build_oneplus_sm8750 (ç®€åŒ–å¤‡ä»½å¯¹æ¯”ç‰ˆ)
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "ğŸ“é€‰æ‹©æœºå‹"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_13'
      keep_original_settings:
        description: "ä¿æŒåŸå†…æ ¸åç§°/æ—¶é—´"
        required: false
        default: true
        type: boolean
      custom_kernel_suffix:
        description: "è‡ªå®šä¹‰å†…æ ¸åç§°ï¼ˆå–æ¶ˆåŸè®¾ç½®æ—¶ç”Ÿæ•ˆï¼‰"
        required: false
        default: ''
      custom_kernel_time:
        description: "è‡ªå®šä¹‰æ„å»ºæ—¶é—´ï¼ˆå–æ¶ˆåŸè®¾ç½®æ—¶ç”Ÿæ•ˆï¼‰"
        required: false
        default: ''
      enable_feature_z:
        description: "æ·»åŠ é£é©°é©±åŠ¨"
        required: false
        default: true
        type: boolean
      enable_feature_b:
        description: "é€‰æ‹©ç½‘ç»œè°ƒåº¦"
        required: false
        type: choice
        options: [ 'FQ_CODEL', 'BBR' ]
        default: 'FQ_CODEL'
      KPM:
        type: boolean
        description: "å¯ç”¨å†…æ ¸æ¨¡å—(KPM)"
        required: true
        default: true

jobs:
  build_with_simple_backup:
    name: Build_${{ github.event.inputs.REPO_MANIFEST }}_Backup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # åˆå§‹åŒ–å¤‡ä»½ç›®å½•ï¼ˆä»…å­˜å¤‡ä»½å’Œå·®å¼‚ï¼Œæ— å¤šä½™æ–‡ä»¶ï¼‰
      - name: ğŸ“ åˆå§‹åŒ–å¤‡ä»½ç›®å½•
        run: |
          BACKUP_DIR="${GITHUB_WORKSPACE}/å…³é”®æ–‡ä»¶å¤‡ä»½_${{ github.event.inputs.REPO_MANIFEST }}"
          mkdir -p "$BACKUP_DIR/lz4_æºç åŒæ­¥å"       # èŠ‚ç‚¹1ï¼šåŒæ­¥æºç åå¤‡ä»½lz4
          mkdir -p "$BACKUP_DIR/config_é…ç½®å‰"        # èŠ‚ç‚¹2ï¼šè®¾ç½®é…ç½®å‰å¤‡ä»½é…ç½®
          mkdir -p "$BACKUP_DIR/config_ç¼–è¯‘å‰"        # èŠ‚ç‚¹3ï¼šç¼–è¯‘å‰å¤‡ä»½é…ç½®
          mkdir -p "$BACKUP_DIR/å·®å¼‚å¯¹æ¯”ç»“æœ"         # å­˜æ”¾æ‰€æœ‰diffæ—¥å¿—
          echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV

      # åŸé€»è¾‘ï¼šè®¾ç½®æœºå‹/ç¯å¢ƒå˜é‡ï¼ˆä¿ç•™ï¼‰
      - name: âš™ï¸ è®¾ç½®åŸºç¡€ç¯å¢ƒ
        run: |
          # æœºå‹é…ç½®
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_ace5_pro)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_ace5_pro_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_ace5_pro" >> $GITHUB_ENV
              ;;
            oneplus_13)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_13_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_13" >> $GITHUB_ENV
              ;;
            *)
              echo "REPO_MANIFEST=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              echo "DEVICES_NAME=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              ;;
          esac
          # å†…æ ¸åç¼€/æ—¶é—´é…ç½®ï¼ˆåŸé€»è¾‘ä¿ç•™ï¼‰
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_13 | oneplus_ace5_pro)
              echo 'DEFAULT_SUFFIX=-android15-8-g4dc61d72e02f-abogki415959920-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Mon May 12 09:09:59 UTC 2025' >> $GITHUB_ENV
              ;;
            realme_GT7pro_Speed)
              echo 'DEFAULT_SUFFIX=-android15-8-g013ec21bba94-abogki383916444-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Tue Dec 17 23:36:49 UTC 2024' >> $GITHUB_ENV
              ;;
            realme_GT7)
              echo 'DEFAULT_SUFFIX=-android15-8-g06c41a4a6e98-abogki395793266-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Mon Jan 20 03:24:58 UTC 2025' >> $GITHUB_ENV
              ;;
            realme_GT7pro)
              echo 'DEFAULT_SUFFIX=-android15-8-gc6f5283046c6-ab12364222-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Fri Sep 13 02:08:57 UTC 2024' >> $GITHUB_ENV
              ;;
            oneplus_13t)
              echo 'DEFAULT_SUFFIX=-android15-8-gd43086512890-abogki423825152-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Tue Jun 10 12:12:23 UTC 2025' >> $GITHUB_ENV
              ;;
            oneplus_pad_2_pro)
              echo 'DEFAULT_SUFFIX=-android15-8-g7b1f455c7143-ab13591283-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Tue Jun  3 03:22:33 UTC 2025' >> $GITHUB_ENV
              ;;
            oneplus_ace5_ultra)
              echo 'DEFAULT_SUFFIX=-android15-8-g29d86c5fc9dd-abogki428889875-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Tue Jul  1 19:48:18 UTC 2025' >> $GITHUB_ENV
              ;;
          esac
          # è‡ªå®šä¹‰é…ç½®ï¼ˆåŸé€»è¾‘ä¿ç•™ï¼‰
          if [ "${{ github.event.inputs.keep_original_settings }}" = "false" ] && [ -n "${{ github.event.inputs.custom_kernel_suffix }}" ]; then
            CUSTOM_TIME="${{ github.event.inputs.custom_kernel_time }}"
            [ -z "$CUSTOM_TIME" ] && CUSTOM_TIME="$(date -u +"%a %b %d %H:%M:%S UTC %Y")"
            echo "KERNEL_TIME=$CUSTOM_TIME" >> $GITHUB_ENV
            echo "DEFAULT_SUFFIX=${{ github.event.inputs.custom_kernel_suffix }}" >> $GITHUB_ENV
          fi
          echo "CCACHE_DIR=$HOME/.ccache_${REPO_MANIFEST}" >> $GITHUB_ENV

      # åŸé€»è¾‘ï¼šä¾èµ–å®‰è£…/ccache/repoåˆå§‹åŒ–ï¼ˆä¿ç•™ï¼‰
      - name: ğŸ“¦ åŸºç¡€ä¾èµ–å‡†å¤‡
        run: |
          # ä¾èµ–å®‰è£…
          sudo apt update -qq && sudo apt install -yq python3 git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev rsync unzip diffutils
          # ccacheåˆå§‹åŒ–
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          ccache -M 8G 2>/dev/null || true
          # repoå®‰è£…
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo && chmod +x ~/repo && sudo mv ~/repo /usr/local/bin/repo

      # èŠ‚ç‚¹1ï¼šåŒæ­¥æºç å â†’ å¤‡ä»½lz4ç›®å½•ï¼ˆåŸå§‹çŠ¶æ€ï¼‰
      - name: ğŸ“¥ åŒæ­¥æºç  + å¤‡ä»½lz4åŸå§‹ç›®å½•
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/showdo/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m ${REPO_MANIFEST}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags
          # å¤‡ä»½æºç åŸå§‹lz4ç›®å½•ï¼ˆå…³é”®èŠ‚ç‚¹1ï¼‰
          LZ4_SRC_PATH="./kernel_platform/common/lib/lz4"
          [ -d "$LZ4_SRC_PATH" ] && cp -r "$LZ4_SRC_PATH" "${{ env.BACKUP_DIR }}/lz4_æºç åŒæ­¥å/"
          # åŸé€»è¾‘ï¼šåˆ é™¤ä¿æŠ¤æ–‡ä»¶
          rm kernel_platform/common/android/abi_gki_protected_exports_* 2>/dev/null || true
          rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* 2>/dev/null || true

      # åŸé€»è¾‘ï¼šSuKiSU/SUSFS/HMBirdé…ç½®ï¼ˆä¿ç•™ï¼Œä¸ä¿®æ”¹ï¼‰
      - name: âš™ï¸ åŸºç¡€åŠŸèƒ½é…ç½®ï¼ˆSuKiSU/SUSFS/HMBirdï¼‰
        run: |
          cd kernel_workspace/kernel_platform
          # SuKiSUé…ç½®
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/setup.sh" -o setup.sh && bash setup.sh susfs-main
          cd KernelSU && KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 10700) && echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV && cd ..
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/setup.bin" ./ && chmod +x setup.bin && ./setup.bin 2>/dev/null && rm setup.bin
          # æ›¿æ¢æ ‡è¯†
          TARGET_FILES=$(grep -rl "TG@qdykernel" . 2>/dev/null || true) && [ -n "$TARGET_FILES" ] && sed -i 's/TG@qdykernel/é…·å®‰Fate007/g' $TARGET_FILES
          # SUSFSé…ç½®
          cd .. && git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android15-6.6 && git clone https://github.com/SukiSU-Ultra/SukiSU_patch.git
          cd kernel_platform && cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android15-6.6.patch ./common/
          cp ../susfs4ksu/kernel_patches/fs/* ./common/fs/ && cp ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./common/include/linux && cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./common/lib
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./common/crypto && cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./common/lib/
          # æœºå‹ç‰¹æ®Šå¤„ç†
          if [ "$DEVICES_NAME" = "oneplus_ace5_ultra" ] && [ "${REPO_MANIFEST}" != "oneplus_13t" ]; then
            sed -i 's/^\(SUBLEVEL[[:space:]]*=[[:space:]]*\).*/\166/' ./common/Makefile
          fi
          # åº”ç”¨è¡¥ä¸
          cd ./common && if [ "$DEVICES_NAME" != "oneplus_ace5_ultra" ] && [ "${REPO_MANIFEST}" != "realme_GT7" ]; then
            files=("lib/lz4/lz4_compress.c" "lib/lz4/lz4_decompress.c" "lib/lz4/lz4defs.h" "lib/lz4/lz4hc_compress.c")
            for file in "${files[@]}"; do [ -e "$file" ] && rm "$file"; done
            # æ‰§è¡Œlz4ç›¸å…³é»‘ç›’ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
            cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ./ && chmod +x main.bin && ./main.bin "setup_lz4" 2>/dev/null && rm main.bin
          fi
          # SUSFSè¡¥ä¸ä¿®æ­£
          if [ "${REPO_MANIFEST}" = "realme_GT7pro_Speed" ] || [ "${REPO_MANIFEST}" = "realme_GT7pro" ]; then
            sed -i 's/-32,12 +32,38/-32,11 +32,37/g' 50_add_susfs_in_gki-android15-6.6.patch && sed -i '/#include <trace\/hooks\/fs.h>/d' 50_add_susfs_in_gki-android15-6.6.patch
          fi
          patch -p1 < 50_add_susfs_in_gki-android15-6.6.patch 2>/dev/null && cp ../../SukiSU_patch/hooks/syscall_hooks.patch ./ && patch -p1 -F 3 < syscall_hooks.patch 2>/dev/null
          # HMBirdé…ç½®
          PATCH_FILE="${{ runner.temp }}/hmbird_patch.c" && [ ! -f "$PATCH_FILE" ] && cp "${GITHUB_WORKSPACE}/hmbird_patch.c" "$PATCH_FILE"
          cd drivers && cp "$PATCH_FILE" hmbird_patch.c && grep -q "hmbird_patch.o" Makefile || echo "obj-y += hmbird_patch.o" >> Makefile

      # èŠ‚ç‚¹2ï¼šè®¾ç½®ç¼–è¯‘é…ç½®å‰ â†’ å¤‡ä»½é…ç½®æ–‡ä»¶ï¼ˆé»‘ç›’ä¿®æ”¹å‰çŠ¶æ€ï¼‰
      - name: ğŸ“ è®¾ç½®é…ç½®å‰ â†’ å¤‡ä»½åŸå§‹é…ç½®
        run: |
          cd kernel_workspace/kernel_platform
          # å¤‡ä»½é…ç½®ç›®å½•ï¼ˆå…³é”®èŠ‚ç‚¹2ï¼‰
          CONFIG_PATH="./common/arch/arm64/configs"
          [ -d "$CONFIG_PATH" ] && cp -r "$CONFIG_PATH" "${{ env.BACKUP_DIR }}/config_é…ç½®å‰/"
          # æ‰§è¡Œé…ç½®é»‘ç›’ï¼ˆåŸé€»è¾‘ä¿ç•™ï¼‰
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ./ && chmod +x main.bin && ./main.bin "setup_gki_config" "${{ github.event.inputs.enable_feature_b }}" 2>/dev/null && rm main.bin
          # åŸé€»è¾‘ï¼šä¿®æ”¹build.config.gki
          sed -i 's/check_defconfig//' ./common/build.config.gki && cd common && git add -A && git commit -a -m "BUILD Kernel" 2>/dev/null

      # èŠ‚ç‚¹3ï¼šç¼–è¯‘å†…æ ¸å‰ â†’ å¤‡ä»½æœ€ç»ˆé…ç½®ï¼ˆé»‘ç›’ä¿®æ”¹åçŠ¶æ€ï¼‰
      - name: ğŸ“ ç¼–è¯‘å‰ â†’ å¤‡ä»½æœ€ç»ˆé…ç½® + å¯¹æ¯”å·®å¼‚
        run: |
          cd kernel_workspace/kernel_platform
          # å¤‡ä»½ç¼–è¯‘å‰é…ç½®ï¼ˆå…³é”®èŠ‚ç‚¹3ï¼‰
          CONFIG_PATH="./common/arch/arm64/configs"
          [ -d "$CONFIG_PATH" ] && cp -r "$CONFIG_PATH" "${{ env.BACKUP_DIR }}/config_ç¼–è¯‘å‰/"
          # å¤‡ä»½å½“å‰lz4ç›®å½•ï¼ˆå¯¹æ¯”æºç åæ˜¯å¦è¢«ä¿®æ”¹ï¼‰
          LZ4_CURRENT_PATH="./common/lib/lz4"
          [ -d "$LZ4_CURRENT_PATH" ] && cp -r "$LZ4_CURRENT_PATH" "${{ env.BACKUP_DIR }}/lz4_ç¼–è¯‘å‰/"
          
          # ç”Ÿæˆå·®å¼‚å¯¹æ¯”ç»“æœï¼ˆæ ¸å¿ƒï¼‰
          DIFF_DIR="${{ env.BACKUP_DIR }}/å·®å¼‚å¯¹æ¯”ç»“æœ"
          # 1. lz4ï¼šæºç åŒæ­¥å vs ç¼–è¯‘å‰ï¼ˆçœ‹é»‘ç›’æ˜¯å¦ä¿®æ”¹lz4ï¼‰
          if [ -d "${{ env.BACKUP_DIR }}/lz4_æºç åŒæ­¥å/lz4" ] && [ -d "${{ env.BACKUP_DIR }}/lz4_ç¼–è¯‘å‰/lz4" ]; then
            diff -urN "${{ env.BACKUP_DIR }}/lz4_æºç åŒæ­¥å/lz4" "${{ env.BACKUP_DIR }}/lz4_ç¼–è¯‘å‰/lz4" > "$DIFF_DIR/lz4_æºç vsç¼–è¯‘å‰.diff" 2>/dev/null
            [ -s "$DIFF_DIR/lz4_æºç vsç¼–è¯‘å‰.diff" ] || echo "lz4ç›®å½•æ— ä¿®æ”¹" > "$DIFF_DIR/lz4_æºç vsç¼–è¯‘å‰.diff"
          else
            echo "lz4ç›®å½•ç¼ºå¤±ï¼Œæ— æ³•å¯¹æ¯”" > "$DIFF_DIR/lz4_æºç vsç¼–è¯‘å‰.diff"
          fi
          # 2. é…ç½®ï¼šè®¾ç½®å‰ vs ç¼–è¯‘å‰ï¼ˆçœ‹é»‘ç›’æ˜¯å¦ä¿®æ”¹é…ç½®ï¼‰
          if [ -d "${{ env.BACKUP_DIR }}/config_é…ç½®å‰/configs" ] && [ -d "${{ env.BACKUP_DIR }}/config_ç¼–è¯‘å‰/configs" ]; then
            diff -urN "${{ env.BACKUP_DIR }}/config_é…ç½®å‰/configs" "${{ env.BACKUP_DIR }}/config_ç¼–è¯‘å‰/configs" > "$DIFF_DIR/config_é…ç½®å‰vsç¼–è¯‘å‰.diff" 2>/dev/null
            # å•ç‹¬å¯¹æ¯”gki_defconfigï¼ˆå…³é”®é…ç½®æ–‡ä»¶ï¼‰
            diff -u "${{ env.BACKUP_DIR }}/config_é…ç½®å‰/configs/gki_defconfig" "${{ env.BACKUP_DIR }}/config_ç¼–è¯‘å‰/configs/gki_defconfig" > "$DIFF_DIR/gki_defconfig_å•ç‹¬å¯¹æ¯”.diff" 2>/dev/null
            [ -s "$DIFF_DIR/config_é…ç½®å‰vsç¼–è¯‘å‰.diff" ] || echo "é…ç½®ç›®å½•æ— ä¿®æ”¹" > "$DIFF_DIR/config_é…ç½®å‰vsç¼–è¯‘å‰.diff"
            [ -s "$DIFF_DIR/gki_defconfig_å•ç‹¬å¯¹æ¯”.diff" ] || echo "gki_defconfigæ— ä¿®æ”¹" > "$DIFF_DIR/gki_defconfig_å•ç‹¬å¯¹æ¯”.diff"
          else
            echo "é…ç½®ç›®å½•ç¼ºå¤±ï¼Œæ— æ³•å¯¹æ¯”" > "$DIFF_DIR/config_é…ç½®å‰vsç¼–è¯‘å‰.diff"
            echo "gki_defconfigç¼ºå¤±ï¼Œæ— æ³•å¯¹æ¯”" > "$DIFF_DIR/gki_defconfig_å•ç‹¬å¯¹æ¯”.diff"
          fi

      # åŸé€»è¾‘ï¼šå†…æ ¸å‘½å/KPM/sched_ext/ç¼–è¯‘/æ‰“åŒ…ï¼ˆä¿ç•™ï¼‰
      - name: ğŸ”¨ å†…æ ¸ç¼–è¯‘ä¸æ‰“åŒ…
        run: |
          cd kernel_workspace/kernel_platform
          # å†…æ ¸å‘½å
          if [ "${{ github.event.inputs.keep_original_settings }}" = "false" ] && [ -n "${{ github.event.inputs.custom_kernel_suffix }}" ]; then
            DEFAULT_SUFFIX="${{ github.event.inputs.custom_kernel_suffix }}"
          fi
          ESCAPED_SUFFIX=$(printf '%s\n' "$DEFAULT_SUFFIX" | sed 's:[\/&]:\\&:g')
          sed -i "s/-4k/$ESCAPED_SUFFIX/g" ./common/arch/arm64/configs/gki_defconfig
          sed -i 's/${scm_version}//' ./common/scripts/setlocalversion
          # KPMé…ç½®
          if [ "${{ github.event.inputs.KPM }}" = "true" ]; then
            echo "CONFIG_KPM=y" >> ./common/arch/arm64/configs/gki_defconfig
            sed -i 's/check_defconfig//' ./common/build.config.gki
          fi
          # sched_exté…ç½®
          if [ "${{ github.event.inputs.enable_feature_z }}" = "true" ]; then
            cd .. && git clone https://github.com/showdo/sched_ext.git && cp -r ./sched_ext/* ./kernel_platform/common/kernel/sched && rm -rf ./sched_ext
          fi
          # å†…æ ¸ç¼–è¯‘
          export PATH="/usr/lib/ccache:$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/prebuilts/clang/host/linux-x86/clang-r510928/bin:$PATH"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}" && export KBUILD_BUILD_TIMESTAMP="${KERNEL_TIME}"
          cd common && make -j$(nproc --all) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="ccache clang" RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole LD=ld.lld HOSTLD=ld.lld O=out KCFLAGS+=-O2 gki_defconfig
          make -j$(nproc --all) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="ccache clang" RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole LD=ld.lld HOSTLD=ld.lld O=out KCFLAGS+=-O2 Image 2>/dev/null
          # KPMè¡¥ä¸
          if [ "${{ github.event.inputs.KPM }}" = "true" ]; then
            cd out/arch/arm64/boot && curl -LO https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/download/0.12.0/patch_linux && chmod +x patch_linux && ./patch_linux 2>/dev/null && rm Image && mv oImage Image
          fi
          # æ‰“åŒ…AnyKernel3
          cd "${GITHUB_WORKSPACE}" && git clone https://github.com/FateYin1/AnyKernel3 --depth=1 && rm -rf ./AnyKernel3/.git
          image_path=$(find "kernel_workspace/kernel_platform" -name "Image" | grep -E "boot/Image$" | head -n1)
          [ -n "$image_path" ] && cp "$image_path" ./AnyKernel3/Image || echo "Imageæ–‡ä»¶ç¼ºå¤±"
          # ä¸‹è½½SukiSU APKï¼ˆå¯é€‰ï¼‰
          run_id=$(gh api "repos/SukiSU-Ultra/SukiSU-Ultra/actions/workflows/build-manager.yml/runs?branch=main&status=success&per_page=1" --jq '.workflow_runs[0].id' 2>/dev/null || echo "")
          [ -n "$run_id" ] && artifact_url=$(gh api "repos/SukiSU-Ultra/SukiSU-Ultra/actions/runs/$run_id/artifacts" | jq -r '.artifacts[] | select(.name == "manager") | .archive_download_url' 2>/dev/null || echo "")
          [ -n "$artifact_url" ] && curl -fL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o manager.zip "$artifact_url" && unzip -j manager.zip "*.apk" -d ./AnyKernel3/ 2>/dev/null && rm manager.zip

      # ä¸Šä¼ å¤‡ä»½å’Œå·®å¼‚ç»“æœï¼ˆæ ¸å¿ƒäº§å‡ºï¼Œç”¨äºæ›¿ä»£é»‘ç›’ï¼‰
      - name: ğŸ“¤ ä¸Šä¼ å¤‡ä»½ä¸å·®å¼‚ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: å¤‡ä»½ä¸å·®å¼‚_${{ env.DEVICES_NAME }}_${{ github.run_id }}
          path: ${{ env.BACKUP_DIR }}/**/*
          retention-days: 30

      # ä¸Šä¼ AnyKernel3ï¼ˆå¯é€‰ï¼‰
      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: AK3_${{ env.KSUVER }}_${{ env.DEVICES_NAME }}_${{ github.event.inputs.KPM == 'true' && 'KPM_' || '' }}${{ github.event.inputs.enable_feature_z == 'true' && 'SCHED_' || '' }}
          path: ./AnyKernel3/*
          retention-days: 7
