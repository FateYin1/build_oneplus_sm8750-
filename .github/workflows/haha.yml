name: Build_oneplus_sm8750 (ÁÆÄÂåñÂ§á‰ªΩÂØπÊØîÁâà)
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "üìùÈÄâÊã©Êú∫Âûã"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_13'
      keep_original_settings:
        description: "‰øùÊåÅÂéüÂÜÖÊ†∏ÂêçÁß∞/Êó∂Èó¥"
        required: false
        default: true
        type: boolean
      custom_kernel_suffix:
        description: "Ëá™ÂÆö‰πâÂÜÖÊ†∏ÂêçÁß∞ÔºàÂèñÊ∂àÂéüËÆæÁΩÆÊó∂ÁîüÊïàÔºâ"
        required: false
        default: ''
      custom_kernel_time:
        description: "Ëá™ÂÆö‰πâÊûÑÂª∫Êó∂Èó¥ÔºàÂèñÊ∂àÂéüËÆæÁΩÆÊó∂ÁîüÊïàÔºâ"
        required: false
        default: ''
      enable_feature_z:
        description: "Ê∑ªÂä†È£éÈ©∞È©±Âä®"
        required: false
        default: true
        type: boolean
      enable_feature_b:
        description: "ÈÄâÊã©ÁΩëÁªúË∞ÉÂ∫¶"
        required: false
        type: choice
        options: [ 'FQ_CODEL', 'BBR' ]
        default: 'FQ_CODEL'
      KPM:
        type: boolean
        description: "ÂêØÁî®ÂÜÖÊ†∏Ê®°Âùó(KPM)"
        required: true
        default: true

jobs:
  build_with_simple_backup:
    name: Build_${{ github.event.inputs.REPO_MANIFEST }}_Backup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ÂàùÂßãÂåñÂ§á‰ªΩÁõÆÂΩïÔºà‰ªÖÂ≠òÂ§á‰ªΩÂíåÂ∑ÆÂºÇÔºåÊó†Â§ö‰ΩôÊñá‰ª∂Ôºâ
      - name: üìÅ ÂàùÂßãÂåñÂ§á‰ªΩÁõÆÂΩï
        run: |
          BACKUP_DIR="${GITHUB_WORKSPACE}/ÂÖ≥ÈîÆÊñá‰ª∂Â§á‰ªΩ_${{ github.event.inputs.REPO_MANIFEST }}"
          mkdir -p "$BACKUP_DIR/lz4_Ê∫êÁ†ÅÂêåÊ≠•Âêé"       # ËäÇÁÇπ1ÔºöÂêåÊ≠•Ê∫êÁ†ÅÂêéÂ§á‰ªΩlz4
          mkdir -p "$BACKUP_DIR/config_ÈÖçÁΩÆÂâç"        # ËäÇÁÇπ2ÔºöËÆæÁΩÆÈÖçÁΩÆÂâçÂ§á‰ªΩÈÖçÁΩÆ
          mkdir -p "$BACKUP_DIR/config_ÁºñËØëÂâç"        # ËäÇÁÇπ3ÔºöÁºñËØëÂâçÂ§á‰ªΩÈÖçÁΩÆ
          mkdir -p "$BACKUP_DIR/Â∑ÆÂºÇÂØπÊØîÁªìÊûú"         # Â≠òÊîæÊâÄÊúâdiffÊó•Âøó
          echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV

      # ÂéüÈÄªËæëÔºöËÆæÁΩÆÊú∫Âûã/ÁéØÂ¢ÉÂèòÈáèÔºà‰øùÁïôÔºâ
      - name: ‚öôÔ∏è ËÆæÁΩÆÂü∫Á°ÄÁéØÂ¢É
        run: |
          # Êú∫ÂûãÈÖçÁΩÆ
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_ace5_pro)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_ace5_pro_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_ace5_pro" >> $GITHUB_ENV
              ;;
            oneplus_13)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_13_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_13" >> $GITHUB_ENV
              ;;
            *)
              echo "REPO_MANIFEST=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              echo "DEVICES_NAME=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              ;;
          esac
          # ÂÜÖÊ†∏ÂêéÁºÄ/Êó∂Èó¥ÈÖçÁΩÆÔºàÂéüÈÄªËæë‰øùÁïôÔºâ
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_13 | oneplus_ace5_pro)
              echo 'DEFAULT_SUFFIX=-android15-8-g4dc61d72e02f-abogki415959920-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Mon May 12 09:09:59 UTC 2025' >> $GITHUB_ENV
              ;;
            realme_GT7pro_Speed)
              echo 'DEFAULT_SUFFIX=-android15-8-g013ec21bba94-abogki383916444-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Tue Dec 17 23:36:49 UTC 2024' >> $GITHUB_ENV
              ;;
            realme_GT7)
              echo 'DEFAULT_SUFFIX=-android15-8-g06c41a4a6e98-abogki395793266-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Mon Jan 20 03:24:58 UTC 2025' >> $GITHUB_ENV
              ;;
            realme_GT7pro)
              echo 'DEFAULT_SUFFIX=-android15-8-gc6f5283046c6-ab12364222-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Fri Sep 13 02:08:57 UTC 2024' >> $GITHUB_ENV
              ;;
            oneplus_13t)
              echo 'DEFAULT_SUFFIX=-android15-8-gd43086512890-abogki423825152-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Tue Jun 10 12:12:23 UTC 2025' >> $GITHUB_ENV
              ;;
            oneplus_pad_2_pro)
              echo 'DEFAULT_SUFFIX=-android15-8-g7b1f455c7143-ab13591283-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Tue Jun  3 03:22:33 UTC 2025' >> $GITHUB_ENV
              ;;
            oneplus_ace5_ultra)
              echo 'DEFAULT_SUFFIX=-android15-8-g29d86c5fc9dd-abogki428889875-4k' >> $GITHUB_ENV
              [ "${{ github.event.inputs.keep_original_settings }}" = "true" ] && echo 'KERNEL_TIME=Tue Jul  1 19:48:18 UTC 2025' >> $GITHUB_ENV
              ;;
          esac
          # Ëá™ÂÆö‰πâÈÖçÁΩÆÔºàÂéüÈÄªËæë‰øùÁïôÔºâ
          if [ "${{ github.event.inputs.keep_original_settings }}" = "false" ] && [ -n "${{ github.event.inputs.custom_kernel_suffix }}" ]; then
            CUSTOM_TIME="${{ github.event.inputs.custom_kernel_time }}"
            [ -z "$CUSTOM_TIME" ] && CUSTOM_TIME="$(date -u +"%a %b %d %H:%M:%S UTC %Y")"
            echo "KERNEL_TIME=$CUSTOM_TIME" >> $GITHUB_ENV
            echo "DEFAULT_SUFFIX=${{ github.event.inputs.custom_kernel_suffix }}" >> $GITHUB_ENV
          fi
          echo "CCACHE_DIR=$HOME/.ccache_${REPO_MANIFEST}" >> $GITHUB_ENV

      # ÂéüÈÄªËæëÔºö‰æùËµñÂÆâË£Ö/ccache/repoÂàùÂßãÂåñÔºà‰øùÁïôÔºâ
      - name: üì¶ Âü∫Á°Ä‰æùËµñÂáÜÂ§á
        run: |
          # ‰æùËµñÂÆâË£Ö
          sudo apt update -qq && sudo apt install -yq python3 git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev rsync unzip diffutils
          # ccacheÂàùÂßãÂåñ
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          ccache -M 8G 2>/dev/null || true
          # repoÂÆâË£Ö
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo && chmod +x ~/repo && sudo mv ~/repo /usr/local/bin/repo

      # ËäÇÁÇπ1ÔºöÂêåÊ≠•Ê∫êÁ†ÅÂêé ‚Üí Â§á‰ªΩlz4ÁõÆÂΩïÔºàÂéüÂßãÁä∂ÊÄÅÔºâ
      - name: üì• ÂêåÊ≠•Ê∫êÁ†Å + Â§á‰ªΩlz4ÂéüÂßãÁõÆÂΩï
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/showdo/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m ${REPO_MANIFEST}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags
          # Â§á‰ªΩÊ∫êÁ†ÅÂéüÂßãlz4ÁõÆÂΩïÔºàÂÖ≥ÈîÆËäÇÁÇπ1Ôºâ
          LZ4_SRC_PATH="./kernel_platform/common/lib/lz4"
          [ -d "$LZ4_SRC_PATH" ] && cp -r "$LZ4_SRC_PATH" "${{ env.BACKUP_DIR }}/lz4_Ê∫êÁ†ÅÂêåÊ≠•Âêé/"
          # ÂéüÈÄªËæëÔºöÂà†Èô§‰øùÊä§Êñá‰ª∂
          rm kernel_platform/common/android/abi_gki_protected_exports_* 2>/dev/null || true
          rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* 2>/dev/null || true

      # ÂéüÈÄªËæëÔºöSuKiSU/SUSFS/HMBirdÈÖçÁΩÆÔºà‰øùÁïôÔºå‰∏ç‰øÆÊîπÔºâ
      - name: ‚öôÔ∏è Âü∫Á°ÄÂäüËÉΩÈÖçÁΩÆÔºàSuKiSU/SUSFS/HMBirdÔºâ
        run: |
          cd kernel_workspace/kernel_platform
          # SuKiSUÈÖçÁΩÆ
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/setup.sh" -o setup.sh && bash setup.sh susfs-main
          cd KernelSU && KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 10700) && echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV && cd ..
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/setup.bin" ./ && chmod +x setup.bin && ./setup.bin 2>/dev/null && rm setup.bin
          # ÊõøÊç¢Ê†áËØÜ
          TARGET_FILES=$(grep -rl "TG@qdykernel" . 2>/dev/null || true) && [ -n "$TARGET_FILES" ] && sed -i 's/TG@qdykernel/ÈÖ∑ÂÆâFate007/g' $TARGET_FILES
          # SUSFSÈÖçÁΩÆ
          cd .. && git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android15-6.6 && git clone https://github.com/SukiSU-Ultra/SukiSU_patch.git
          cd kernel_platform && cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android15-6.6.patch ./common/
          cp ../susfs4ksu/kernel_patches/fs/* ./common/fs/ && cp ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./common/include/linux && cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./common/lib
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./common/crypto && cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./common/lib/
          # Êú∫ÂûãÁâπÊÆäÂ§ÑÁêÜ
          if [ "$DEVICES_NAME" = "oneplus_ace5_ultra" ] && [ "${REPO_MANIFEST}" != "oneplus_13t" ]; then
            sed -i 's/^\(SUBLEVEL[[:space:]]*=[[:space:]]*\).*/\166/' ./common/Makefile
          fi
          # Â∫îÁî®Ë°•‰∏Å
          cd ./common && if [ "$DEVICES_NAME" != "oneplus_ace5_ultra" ] && [ "${REPO_MANIFEST}" != "realme_GT7" ]; then
            files=("lib/lz4/lz4_compress.c" "lib/lz4/lz4_decompress.c" "lib/lz4/lz4defs.h" "lib/lz4/lz4hc_compress.c")
            for file in "${files[@]}"; do [ -e "$file" ] && rm "$file"; done
            # ÊâßË°ålz4Áõ∏ÂÖ≥ÈªëÁõíÔºà‰øùÁïôÂéüÈÄªËæëÔºâ
            cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ./ && chmod +x main.bin && ./main.bin "setup_lz4" 2>/dev/null && rm main.bin
          fi
          # SUSFSË°•‰∏Å‰øÆÊ≠£
          if [ "${REPO_MANIFEST}" = "realme_GT7pro_Speed" ] || [ "${REPO_MANIFEST}" = "realme_GT7pro" ]; then
            sed -i 's/-32,12 +32,38/-32,11 +32,37/g' 50_add_susfs_in_gki-android15-6.6.patch && sed -i '/#include <trace\/hooks\/fs.h>/d' 50_add_susfs_in_gki-android15-6.6.patch
          fi
          patch -p1 < 50_add_susfs_in_gki-android15-6.6.patch 2>/dev/null && cp ../../SukiSU_patch/hooks/syscall_hooks.patch ./ && patch -p1 -F 3 < syscall_hooks.patch 2>/dev/null
          # HMBirdÈÖçÁΩÆ
          PATCH_FILE="${{ runner.temp }}/hmbird_patch.c" && [ ! -f "$PATCH_FILE" ] && cp "${GITHUB_WORKSPACE}/hmbird_patch.c" "$PATCH_FILE"
          cd drivers && cp "$PATCH_FILE" hmbird_patch.c && grep -q "hmbird_patch.o" Makefile || echo "obj-y += hmbird_patch.o" >> Makefile

      # ËäÇÁÇπ2ÔºöËÆæÁΩÆÁºñËØëÈÖçÁΩÆÂâç ‚Üí Â§á‰ªΩÈÖçÁΩÆÊñá‰ª∂ÔºàÈªëÁõí‰øÆÊîπÂâçÁä∂ÊÄÅÔºâ
      - name: üìù ËÆæÁΩÆÈÖçÁΩÆÂâç ‚Üí Â§á‰ªΩÂéüÂßãÈÖçÁΩÆ
        run: |
          cd kernel_workspace/kernel_platform
          # Â§á‰ªΩÈÖçÁΩÆÁõÆÂΩïÔºàÂÖ≥ÈîÆËäÇÁÇπ2Ôºâ
          CONFIG_PATH="./common/arch/arm64/configs"
          [ -d "$CONFIG_PATH" ] && cp -r "$CONFIG_PATH" "${{ env.BACKUP_DIR }}/config_ÈÖçÁΩÆÂâç/"
          # ÊâßË°åÈÖçÁΩÆÈªëÁõíÔºàÂéüÈÄªËæë‰øùÁïôÔºâ
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ./ && chmod +x main.bin && ./main.bin "setup_gki_config" "${{ github.event.inputs.enable_feature_b }}" 2>/dev/null && rm main.bin
          # ÂéüÈÄªËæëÔºö‰øÆÊîπbuild.config.gki
          sed -i 's/check_defconfig//' ./common/build.config.gki && cd common && git add -A && git commit -a -m "BUILD Kernel" 2>/dev/null

      # ËäÇÁÇπ3ÔºöÁºñËØëÂÜÖÊ†∏Ââç ‚Üí Â§á‰ªΩÊúÄÁªàÈÖçÁΩÆÔºàÈªëÁõí‰øÆÊîπÂêéÁä∂ÊÄÅÔºâ
      - name: üìù ÁºñËØëÂâç ‚Üí Â§á‰ªΩÊúÄÁªàÈÖçÁΩÆ + ÂØπÊØîÂ∑ÆÂºÇ
        run: |
          cd kernel_workspace/kernel_platform
          # Â§á‰ªΩÁºñËØëÂâçÈÖçÁΩÆÔºàÂÖ≥ÈîÆËäÇÁÇπ3Ôºâ
          CONFIG_PATH="./common/arch/arm64/configs"
          [ -d "$CONFIG_PATH" ] && cp -r "$CONFIG_PATH" "${{ env.BACKUP_DIR }}/config_ÁºñËØëÂâç/"
          # Â§á‰ªΩÂΩìÂâçlz4ÁõÆÂΩïÔºàÂØπÊØîÊ∫êÁ†ÅÂêéÊòØÂê¶Ë¢´‰øÆÊîπÔºâ
          LZ4_CURRENT_PATH="./common/lib/lz4"
          [ -d "$LZ4_CURRENT_PATH" ] && cp -r "$LZ4_CURRENT_PATH" "${{ env.BACKUP_DIR }}/lz4_ÁºñËØëÂâç/"
          
          # ÁîüÊàêÂ∑ÆÂºÇÂØπÊØîÁªìÊûúÔºàÊ†∏ÂøÉÔºâ
          DIFF_DIR="${{ env.BACKUP_DIR }}/Â∑ÆÂºÇÂØπÊØîÁªìÊûú"
          # 1. lz4ÔºöÊ∫êÁ†ÅÂêåÊ≠•Âêé vs ÁºñËØëÂâçÔºàÁúãÈªëÁõíÊòØÂê¶‰øÆÊîπlz4Ôºâ
          if [ -d "${{ env.BACKUP_DIR }}/lz4_Ê∫êÁ†ÅÂêåÊ≠•Âêé/lz4" ] && [ -d "${{ env.BACKUP_DIR }}/lz4_ÁºñËØëÂâç/lz4" ]; then
            diff -urN "${{ env.BACKUP_DIR }}/lz4_Ê∫êÁ†ÅÂêåÊ≠•Âêé/lz4" "${{ env.BACKUP_DIR }}/lz4_ÁºñËØëÂâç/lz4" > "$DIFF_DIR/lz4_Ê∫êÁ†ÅvsÁºñËØëÂâç.diff" 2>/dev/null
            [ -s "$DIFF_DIR/lz4_Ê∫êÁ†ÅvsÁºñËØëÂâç.diff" ] || echo "lz4ÁõÆÂΩïÊó†‰øÆÊîπ" > "$DIFF_DIR/lz4_Ê∫êÁ†ÅvsÁºñËØëÂâç.diff"
          else
            echo "lz4ÁõÆÂΩïÁº∫Â§±ÔºåÊó†Ê≥ïÂØπÊØî" > "$DIFF_DIR/lz4_Ê∫êÁ†ÅvsÁºñËØëÂâç.diff"
          fi
          # 2. ÈÖçÁΩÆÔºöËÆæÁΩÆÂâç vs ÁºñËØëÂâçÔºàÁúãÈªëÁõíÊòØÂê¶‰øÆÊîπÈÖçÁΩÆÔºâ
          if [ -d "${{ env.BACKUP_DIR }}/config_ÈÖçÁΩÆÂâç/configs" ] && [ -d "${{ env.BACKUP_DIR }}/config_ÁºñËØëÂâç/configs" ]; then
            diff -urN "${{ env.BACKUP_DIR }}/config_ÈÖçÁΩÆÂâç/configs" "${{ env.BACKUP_DIR }}/config_ÁºñËØëÂâç/configs" > "$DIFF_DIR/config_ÈÖçÁΩÆÂâçvsÁºñËØëÂâç.diff" 2>/dev/null
            # ÂçïÁã¨ÂØπÊØîgki_defconfigÔºàÂÖ≥ÈîÆÈÖçÁΩÆÊñá‰ª∂Ôºâ
            diff -u "${{ env.BACKUP_DIR }}/config_ÈÖçÁΩÆÂâç/configs/gki_defconfig" "${{ env.BACKUP_DIR }}/config_ÁºñËØëÂâç/configs/gki_defconfig" > "$DIFF_DIR/gki_defconfig_ÂçïÁã¨ÂØπÊØî.diff" 2>/dev/null
            [ -s "$DIFF_DIR/config_ÈÖçÁΩÆÂâçvsÁºñËØëÂâç.diff" ] || echo "ÈÖçÁΩÆÁõÆÂΩïÊó†‰øÆÊîπ" > "$DIFF_DIR/config_ÈÖçÁΩÆÂâçvsÁºñËØëÂâç.diff"
            [ -s "$DIFF_DIR/gki_defconfig_ÂçïÁã¨ÂØπÊØî.diff" ] || echo "gki_defconfigÊó†‰øÆÊîπ" > "$DIFF_DIR/gki_defconfig_ÂçïÁã¨ÂØπÊØî.diff"
          else
            echo "ÈÖçÁΩÆÁõÆÂΩïÁº∫Â§±ÔºåÊó†Ê≥ïÂØπÊØî" > "$DIFF_DIR/config_ÈÖçÁΩÆÂâçvsÁºñËØëÂâç.diff"
            echo "gki_defconfigÁº∫Â§±ÔºåÊó†Ê≥ïÂØπÊØî" > "$DIFF_DIR/gki_defconfig_ÂçïÁã¨ÂØπÊØî.diff"
          fi

      # ÂéüÈÄªËæëÔºöÂÜÖÊ†∏ÂëΩÂêç/KPM/sched_ext/ÁºñËØë/ÊâìÂåÖÔºà‰øùÁïôÔºâ
      - name: üî® ÂÜÖÊ†∏ÁºñËØë‰∏éÊâìÂåÖ
        run: |
          cd kernel_workspace/kernel_platform
          # ÂÜÖÊ†∏ÂëΩÂêç
          if [ "${{ github.event.inputs.keep_original_settings }}" = "false" ] && [ -n "${{ github.event.inputs.custom_kernel_suffix }}" ]; then
            DEFAULT_SUFFIX="${{ github.event.inputs.custom_kernel_suffix }}"
          fi
          ESCAPED_SUFFIX=$(printf '%s\n' "$DEFAULT_SUFFIX" | sed 's:[\/&]:\\&:g')
          sed -i "s/-4k/$ESCAPED_SUFFIX/g" ./common/arch/arm64/configs/gki_defconfig
          sed -i 's/${scm_version}//' ./common/scripts/setlocalversion
          # KPMÈÖçÁΩÆ
          if [ "${{ github.event.inputs.KPM }}" = "true" ]; then
            echo "CONFIG_KPM=y" >> ./common/arch/arm64/configs/gki_defconfig
            sed -i 's/check_defconfig//' ./common/build.config.gki
          fi
          # sched_extÈÖçÁΩÆ
          if [ "${{ github.event.inputs.enable_feature_z }}" = "true" ]; then
            cd .. && git clone https://github.com/showdo/sched_ext.git && cp -r ./sched_ext/* ./kernel_platform/common/kernel/sched && rm -rf ./sched_ext
          fi
          # ÂÜÖÊ†∏ÁºñËØë
          export PATH="/usr/lib/ccache:$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/prebuilts/clang/host/linux-x86/clang-r510928/bin:$PATH"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}" && export KBUILD_BUILD_TIMESTAMP="${KERNEL_TIME}"
          cd common && make -j$(nproc --all) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="ccache clang" RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole LD=ld.lld HOSTLD=ld.lld O=out KCFLAGS+=-O2 gki_defconfig
          make -j$(nproc --all) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="ccache clang" RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole LD=ld.lld HOSTLD=ld.lld O=out KCFLAGS+=-O2 Image 2>/dev/null
          # KPMË°•‰∏Å
          if [ "${{ github.event.inputs.KPM }}" = "true" ]; then
            cd out/arch/arm64/boot && curl -LO https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/download/0.12.0/patch_linux && chmod +x patch_linux && ./patch_linux 2>/dev/null && rm Image && mv oImage Image
          fi
          # ÊâìÂåÖAnyKernel3
          cd "${GITHUB_WORKSPACE}" && git clone https://github.com/FateYin1/AnyKernel3 --depth=1 && rm -rf ./AnyKernel3/.git
          image_path=$(find "kernel_workspace/kernel_platform" -name "Image" | grep -E "boot/Image$" | head -n1)
          [ -n "$image_path" ] && cp "$image_path" ./AnyKernel3/Image || echo "ImageÊñá‰ª∂Áº∫Â§±"
          # ‰∏ãËΩΩSukiSU APKÔºàÂèØÈÄâÔºâ
          run_id=$(gh api "repos/SukiSU-Ultra/SukiSU-Ultra/actions/workflows/build-manager.yml/runs?branch=main&status=success&per_page=1" --jq '.workflow_runs[0].id' 2>/dev/null || echo "")
          [ -n "$run_id" ] && artifact_url=$(gh api "repos/SukiSU-Ultra/SukiSU-Ultra/actions/runs/$run_id/artifacts" | jq -r '.artifacts[] | select(.name == "manager") | .archive_download_url' 2>/dev/null || echo "")
          [ -n "$artifact_url" ] && curl -fL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o manager.zip "$artifact_url" && unzip -j manager.zip "*.apk" -d ./AnyKernel3/ 2>/dev/null && rm manager.zip

      # ‰∏ä‰º†Â§á‰ªΩÂíåÂ∑ÆÂºÇÁªìÊûúÔºàÊ†∏ÂøÉ‰∫ßÂá∫ÔºåÁî®‰∫éÊõø‰ª£ÈªëÁõíÔºâ
      - name: üì§ ‰∏ä‰º†Â§á‰ªΩ‰∏éÂ∑ÆÂºÇÁªìÊûú
        uses: actions/upload-artifact@v4
        with:
          name: Â§á‰ªΩ‰∏éÂ∑ÆÂºÇ_${{ env.DEVICES_NAME }}_${{ github.run_id }}
          path: ${{ env.BACKUP_DIR }}/**/*
          retention-days: 30

      # ‰∏ä‰º†AnyKernel3ÔºàÂèØÈÄâÔºâ
      - name: üì§ ‰∏ä‰º†ÁºñËØë‰∫ßÁâ©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: AK3_${{ env.KSUVER }}_${{ env.DEVICES_NAME }}_${{ github.event.inputs.KPM == 'true' && 'KPM_' || '' }}${{ github.event.inputs.enable_feature_z == 'true' && 'SCHED_' || '' }}
          path: ./AnyKernel3/*
          retention-days: 7
