name: 简化版逆向加密文件
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "选择机型"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
        default: 'oneplus_13'
      BIN_PATH:
        description: "加密文件路径（如：.github/Bin）"
        required: true
        default: ".github/Bin"

jobs:
  reverse:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库（含加密文件）
        uses: actions/checkout@v4

      - name: 创建逆向结果目录
        run: |
          REVERSE_DIR="${GITHUB_WORKSPACE}/逆向结果"
          mkdir -p "$REVERSE_DIR/setup" "$REVERSE_DIR/main"
          echo "REVERSE_DIR=$REVERSE_DIR" >> $GITHUB_ENV

      - name: 安装基础工具（含repo）
        run: |
          # 直接安装必要工具，不做复杂缓存配置
          sudo apt update
          sudo apt install -y git curl strace diffutils
          # 安装repo（简化步骤，只做必要修复）
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/bin/repo  # 确保路径在PATH中
          # 修复Python3时间戳问题（只改必要行）
          sudo sed -i 's/import datetime/import datetime\nfrom datetime import UTC/' /usr/bin/repo
          sudo sed -i 's/datetime.datetime.utcnow()/datetime.datetime.now(UTC)/g' /usr/bin/repo
          # 验证repo是否可用
          repo --version || echo "repo安装完成"

      - name: 同步内核源码
        run: |
          mkdir -p kernel_workspace && cd kernel_workspace
          # 同步源码（只记录关键日志）
          repo init -u https://github.com/showdo/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m ${{ github.event.inputs.REPO_MANIFEST }}.xml --depth=1
          repo sync -c -j4  # 减少并行数，避免出错
          # 确认源码目录存在
          if [ ! -d "kernel_platform" ]; then
            echo "::error ::源码同步失败，未找到kernel_platform"
            exit 1
          fi

      - name: 逆向setup.bin（执行前备份）
        run: |
          cd kernel_workspace/kernel_platform
          # 初始化SuKiSU环境
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/setup.sh" -o setup.sh && bash setup.sh susfs-main
          # 备份执行前状态
          cp -r KernelSU "$REVERSE_DIR/setup/前"

      - name: 执行setup.bin并跟踪
        run: |
          cd kernel_workspace/kernel_platform/KernelSU
          # 复制加密文件
          cp "${GITHUB_WORKSPACE}/${{ github.event.inputs.BIN_PATH }}/setup.bin" ./
          chmod +x setup.bin
          # 跟踪执行
          strace -o "$REVERSE_DIR/setup/strace.log" ./setup.bin
          # 备份执行后状态
          cp -r . "$REVERSE_DIR/setup/后"

      - name: 生成setup.bin差异
        run: |
          diff -urN "$REVERSE_DIR/setup/前" "$REVERSE_DIR/setup/后" > "$REVERSE_DIR/setup/差异.diff"

      - name: 逆向main.bin（执行前备份）
        run: |
          cd kernel_workspace/kernel_platform/common
          # 备份原始lz4目录
          cp -r lib/lz4 "$REVERSE_DIR/main/前"

      - name: 执行main.bin并跟踪
        run: |
          cd kernel_workspace/kernel_platform/common
          # 复制加密文件
          cp "${GITHUB_WORKSPACE}/${{ github.event.inputs.BIN_PATH }}/main.bin" ./
          chmod +x main.bin
          # 跟踪执行
          strace -o "$REVERSE_DIR/main/strace.log" ./main.bin "setup_lz4"
          # 备份执行后状态（关键：获取新文件）
          cp -r lib/lz4 "$REVERSE_DIR/main/后"

      - name: 生成main.bin差异
        run: |
          diff -urN "$REVERSE_DIR/main/前" "$REVERSE_DIR/main/后" > "$REVERSE_DIR/main/差异.diff"

      - name: 上传逆向结果
        uses: actions/upload-artifact@v4
        with:
          name: 逆向结果
          path: ${{ env.REVERSE_DIR }}
          retention-days: 90
