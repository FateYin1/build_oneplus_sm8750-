name: LZ4_ZSTD_Patch_Generator
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "é€‰æ‹©æœºå‹"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_13'


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®æœºå‹ç¯å¢ƒå˜é‡
        run: |
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_ace5_pro)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_ace5_pro_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_ace5_pro" >> $GITHUB_ENV
              ;;
            *)
              echo "REPO_MANIFEST=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              echo "DEVICES_NAME=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              ;;
          esac

      - name: å®‰è£…ä¾èµ–ï¼ˆå«ç›‘æ§å·¥å…·ï¼‰
        run: |
          sudo apt update -y
          sudo apt install -y git ccache inotify-tools strace coreutils python3 python3-pip
          # å¸è½½ç³»ç»Ÿæ—§ç‰ˆrepoï¼ˆé¿å…å†²çªï¼‰
          sudo apt remove -y repo || true

      - name: å®‰è£…æœ€æ–°ç‰ˆRepoå·¥å…·ï¼ˆä¿®å¤è­¦å‘Šï¼‰
        run: |
          # åˆ›å»ºç”¨æˆ·çº§äºŒè¿›åˆ¶ç›®å½•ï¼ˆç¡®ä¿å¯å†™ï¼‰
          mkdir -p ~/bin
          echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
          source ~/.bashrc
          
          # ä¸‹è½½æœ€æ–°ç‰ˆrepo launcherï¼ˆæ¥è‡ªå®˜æ–¹æºï¼‰
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          
          # ä¿®å¤Pythonè¯­æ³•è­¦å‘Šï¼ˆæ›¿æ¢utcnow()ä¸º timezone-aware å†™æ³•ï¼‰
          sed -i 's/import datetime/import datetime\nfrom datetime import UTC/' ~/bin/repo
          sed -i 's/datetime.datetime.utcnow()/datetime.datetime.now(UTC)/g' ~/bin/repo
          
          # éªŒè¯å®‰è£…
          echo "ä½¿ç”¨çš„repoè·¯å¾„ï¼š$(which repo)"
          echo "repoç‰ˆæœ¬ï¼š$(repo --version | head -n1)"

      - name: åŒæ­¥å†…æ ¸æºç 
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          # ä½¿ç”¨æ–°ç‰ˆrepoåˆå§‹åŒ–ï¼Œæ¶ˆé™¤è­¦å‘Š
          repo init -u https://github.com/showdo/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m ${REPO_MANIFEST}.xml --depth=1
          # åŒæ­¥æºç ï¼Œå¢åŠ --no-clone-bundleæå‡å…¼å®¹æ€§
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle

      - name: æ ¸å¿ƒæ­¥éª¤ï¼šç›‘æ§å¹¶ç”ŸæˆLZ4/ZSTDè¡¥ä¸ï¼ˆå«æ±‡ç¼–æ–‡ä»¶ï¼‰
        run: |
          # å®šä¹‰å…³é”®è·¯å¾„
          COMMON_DIR="kernel_workspace/kernel_platform/common"
          LZ4_DIR="$COMMON_DIR/lib/lz4"       # LZ4æ ¸å¿ƒç›®å½•
          ZSTD_DIR="$COMMON_DIR/lib/zstd"     # ZSTDæ ¸å¿ƒç›®å½•
          BACKUP_DIR="${GITHUB_WORKSPACE}/lz4_zstd_backup"  # åŸå§‹æ–‡ä»¶å¤‡ä»½
          PATCH_DIR="${GITHUB_WORKSPACE}/lz4_zstd_patches"  # æœ€ç»ˆè¡¥ä¸è¾“å‡º
          MONITOR_LOG="${GITHUB_WORKSPACE}/monitor_logs"     # ç›‘æ§æ—¥å¿—
          mkdir -p "$BACKUP_DIR" "$PATCH_DIR" "$MONITOR_LOG"

          # -------------------------- 1. å¤‡ä»½åŸå§‹æ–‡ä»¶ï¼ˆå«æ±‡ç¼–æ–‡ä»¶ï¼‰ --------------------------
          echo "ğŸ“‹ å¤‡ä»½LZ4/ZSTDåŸå§‹æ–‡ä»¶ï¼ˆå«.sæ±‡ç¼–æ–‡ä»¶ï¼‰"
          
          # å¤‡ä»½LZ4ç›¸å…³æ–‡ä»¶ï¼ˆæ˜ç¡®åŒ…å«.sæ±‡ç¼–æ–‡ä»¶ï¼‰
          for file in $(find "$LZ4_DIR" -type f \( -name "*.c" -o -name "*.h" -o -name "*.s" -o -name "Makefile" -o -name "*.mk" \)); do
            rel_path="${file#$COMMON_DIR/}"  # ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚lib/lz4/lz4_asm.sï¼‰
            mkdir -p "$BACKUP_DIR/$(dirname "$rel_path")"
            cp "$file" "$BACKUP_DIR/$rel_path"
            echo "âœ… å¤‡ä»½LZ4æ–‡ä»¶ï¼š$rel_path"
          done
          
          # å¤‡ä»½ZSTDç›¸å…³æ–‡ä»¶ï¼ˆæ˜ç¡®åŒ…å«.sæ±‡ç¼–æ–‡ä»¶ï¼‰
          for file in $(find "$ZSTD_DIR" -type f \( -name "*.c" -o -name "*.h" -o -name "*.s" -o -name "Makefile" -o -name "*.mk" \)); do
            rel_path="${file#$COMMON_DIR/}"
            mkdir -p "$BACKUP_DIR/$(dirname "$rel_path")"
            cp "$file" "$BACKUP_DIR/$rel_path"
            echo "âœ… å¤‡ä»½ZSTDæ–‡ä»¶ï¼š$rel_path"
          done

          # -------------------------- 2. å¯åŠ¨å¤šç»´åº¦ç›‘æ§ï¼ˆèšç„¦LZ4/ZSTDï¼‰ --------------------------
          echo "ğŸ” å¯åŠ¨ç›‘æ§ï¼ˆä»…è·Ÿè¸ªLZ4/ZSTDç›®å½•ï¼‰"
          
          # 2.1 inotifyå®æ—¶ç›‘æ§ï¼ˆä»…ç›‘æ§LZ4å’ŒZSTDç›®å½•ï¼‰
          INOTIFY_LOG="$MONITOR_LOG/inotify.log"
          inotifywait -m -r \
            --timefmt "%Y-%m-%d %H:%M:%S" \
            --format "%T %e %w%f" \
            -e create -e delete -e modify -e move \
            "$LZ4_DIR" "$ZSTD_DIR" > "$INOTIFY_LOG" 2>&1 &
          INOTIFY_PID=$!
          
          # 2.2 è®°å½•gitåˆå§‹çŠ¶æ€ï¼ˆç”¨äºåç»­diffï¼‰
          cd "$COMMON_DIR"
          git add -A
          git commit -m "Initial state before main.bin" || true
          INIT_COMMIT=$(git rev-parse HEAD)

          # -------------------------- 3. æ‰§è¡Œmain.binï¼ˆè§¦å‘ä¿®æ”¹ï¼‰ --------------------------
          echo "ğŸ”§ æ‰§è¡Œmain.binï¼ˆä»…å…³æ³¨LZ4/ZSTDä¿®æ”¹ï¼‰"
          cd "$COMMON_DIR"
          
          # æ¸…ç†åŸæœ‰æ–‡ä»¶ï¼ˆæ¨¡æ‹ŸåŸå·¥ä½œæµï¼‰
          rm -f lib/lz4/lz4_compress.c lib/lz4/lz4_decompress.c lib/lz4/lz4defs.h lib/lz4/lz4hc_compress.c
          
          # æ‰§è¡ŒåŠ å¯†è„šæœ¬ï¼ˆå‡è®¾main.binåœ¨å½“å‰ç›®å½•ï¼‰
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ./
          chmod +x main.bin
          
          # ç”¨straceç›‘æ§ç³»ç»Ÿè°ƒç”¨ï¼ˆä»…è®°å½•LZ4/ZSTDç›¸å…³æ–‡ä»¶æ“ä½œï¼‰
          STRACE_LOG="$MONITOR_LOG/strace.log"
          strace -f -e trace=file -o "$STRACE_LOG" ./main.bin "setup_lz4"
          
          # åœæ­¢inotifyç›‘æ§
          kill $INOTIFY_PID
          rm -f main.bin

          # -------------------------- 4. åˆ†æç›‘æ§ç»“æœï¼ˆæå–LZ4/ZSTDæ”¹åŠ¨ï¼‰ --------------------------
          echo "ğŸ“Š åˆ†æç›‘æ§ç»“æœï¼Œæå–LZ4/ZSTDæ”¹åŠ¨"
          
          # 4.1 ä»git diffæå–LZ4/ZSTDæ”¹åŠ¨
          git diff $INIT_COMMIT --name-only | grep -E "^lib/lz4/|^lib/zstd/" > "$MONITOR_LOG/git_changed.txt"
          
          # 4.2 ä»inotifyæå–LZ4/ZSTDæ”¹åŠ¨
          grep -E "$LZ4_DIR|$ZSTD_DIR" "$INOTIFY_LOG" | awk '{print $3}' | sed "s|$COMMON_DIR/||" >> "$MONITOR_LOG/inotify_changed.txt"
          
          # 4.3 ä»straceæå–LZ4/ZSTDæ”¹åŠ¨
          grep -E "$LZ4_DIR|$ZSTD_DIR" "$STRACE_LOG" | awk -F'"' '{print $2}' | sed "s|$COMMON_DIR/||" >> "$MONITOR_LOG/strace_changed.txt"
          
          # 4.4 æ•´åˆæ‰€æœ‰æ”¹åŠ¨æ–‡ä»¶ï¼ˆå»é‡ï¼‰
          cat "$MONITOR_LOG/git_changed.txt" "$MONITOR_LOG/inotify_changed.txt" "$MONITOR_LOG/strace_changed.txt" \
            | sort | uniq | grep -E "^lib/lz4/|^lib/zstd/" > "$MONITOR_LOG/all_changed.txt"
          
          echo "=== æ£€æµ‹åˆ°çš„LZ4/ZSTDæ”¹åŠ¨æ–‡ä»¶ ==="
          cat "$MONITOR_LOG/all_changed.txt"

          # -------------------------- 5. ç”Ÿæˆçº¯å‡€çš„LZ4/ZSTDè¡¥ä¸ï¼ˆå«æ±‡ç¼–æ–‡ä»¶ï¼‰ --------------------------
          echo "ğŸ”¨ ç”ŸæˆLZ4/ZSTDè¡¥ä¸ï¼ˆå«.sæ±‡ç¼–æ–‡ä»¶ï¼‰"
          
          while read -r file; do
            # å¤„ç†ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆç”Ÿæˆdiffè¡¥ä¸ï¼‰
            if [ -f "$BACKUP_DIR/$file" ] && [ -f "$COMMON_DIR/$file" ]; then
              # ç”Ÿæˆè¡¥ä¸ï¼ˆå¿½ç•¥ç©ºç™½å·®å¼‚ï¼‰
              diff -u -w "$BACKUP_DIR/$file" "$COMMON_DIR/$file" > "$PATCH_DIR/$(echo "$file" | tr '/' '_').patch"
              if [ -s "$PATCH_DIR/$(echo "$file" | tr '/' '_').patch" ]; then
                echo "âœ… ç”Ÿæˆè¡¥ä¸ï¼š$file"
              else
                rm "$PATCH_DIR/$(echo "$file" | tr '/' '_').patch"  # ç©ºè¡¥ä¸åˆ é™¤
              fi
              
            # å¤„ç†æ–°å¢çš„æ–‡ä»¶ï¼ˆç›´æ¥ä¿å­˜ï¼‰
            elif [ ! -f "$BACKUP_DIR/$file" ] && [ -f "$COMMON_DIR/$file" ]; then
              mkdir -p "$PATCH_DIR/$(dirname "$file")"
              cp "$COMMON_DIR/$file" "$PATCH_DIR/$file"
              echo "âœ… ä¿å­˜æ–°å¢æ–‡ä»¶ï¼š$file"
            fi
          done < "$MONITOR_LOG/all_changed.txt"

          # éªŒè¯è¡¥ä¸ç”Ÿæˆç»“æœ
          if [ -n "$(ls -A "$PATCH_DIR" 2>/dev/null)" ]; then
            echo "âœ… LZ4/ZSTDè¡¥ä¸ç”Ÿæˆå®Œæˆï¼Œè·¯å¾„ï¼š$PATCH_DIR"
          else
            echo "âš ï¸ æœªæ£€æµ‹åˆ°LZ4/ZSTDæ”¹åŠ¨ï¼Œæœªç”Ÿæˆè¡¥ä¸"
          fi

      - name: ä¸Šä¼ LZ4/ZSTDè¡¥ä¸ï¼ˆå«æ±‡ç¼–æ–‡ä»¶ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: lz4_zstd_patches_with_asm_${{ env.DEVICES_NAME }}
          path: |
            ./lz4_zstd_patches/  # æœ€ç»ˆè¡¥ä¸ï¼ˆå«.sæ±‡ç¼–æ–‡ä»¶ï¼‰
            ./monitor_logs/      # ç›‘æ§æ—¥å¿—ï¼ˆç”¨äºæ’æŸ¥ï¼‰
          retention-days: 365
