name: LZ4_ZSTD_Patch_Generator
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "é€‰æ‹©æœºå‹"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_13'


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»“åº“ä»£ç 
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½®æœºå‹ç¯å¢ƒå˜é‡ï¼ˆåŒ¹é…showdo/kernel_manifestçš„xmlå‘½åï¼‰
      - name: âš™ï¸ è®¾ç½®æœºå‹ç¯å¢ƒå˜é‡
        run: |
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_ace5_pro)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_ace5_pro_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_ace5_pro" >> $GITHUB_ENV
              ;;
            oneplus_13)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_13_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_13" >> $GITHUB_ENV
              ;;
            *)
              echo "REPO_MANIFEST=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              echo "DEVICES_NAME=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              ;;
          esac

      # 3. å®‰è£…ä¾èµ–ï¼ˆå«ç›‘æ§å·¥å…·+å¸è½½æ—§repoï¼‰
      - name: ğŸ“¦ å®‰è£…ä¾èµ–ï¼ˆå«ç›‘æ§å·¥å…·ï¼‰
        run: |
          # æ¸…ç†apté”æ–‡ä»¶ï¼Œé¿å…å†²çª
          sudo rm -f /var/lib/apt/lists/lock /var/lib/dpkg/lock
          # æ›´æ–°aptå¹¶å®‰è£…ä¾èµ–
          sudo apt update -y
          sudo apt install -y \
            git ccache inotify-tools strace coreutils python3 python3-pip \
            build-essential libelf-dev flex bison libssl-dev  # è¡¥å……å†…æ ¸ç¼–è¯‘åŸºç¡€ä¾èµ–
          # å¸è½½ç³»ç»Ÿæ—§ç‰ˆrepoï¼Œé¿å…è·¯å¾„å†²çª
          sudo apt remove -y repo || true
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼Œæ—§ç‰ˆrepoå·²å¸è½½"

      # 4. å®‰è£…æœ€æ–°ç‰ˆRepoå·¥å…·ï¼ˆä¿®å¤å‘½ä»¤æ‰¾ä¸åˆ°+è¯­æ³•è­¦å‘Šï¼‰
      - name: ğŸ“¥ å®‰è£…æœ€æ–°ç‰ˆRepoå·¥å…·ï¼ˆç¡®ä¿å‘½ä»¤å¯è¯†åˆ«ï¼‰
        run: |
          # 1. ä½¿ç”¨ç»å¯¹è·¯å¾„åˆ›å»ºrepoç›®å½•ï¼ˆGitHub Actions runnerå›ºå®šhomeè·¯å¾„ï¼‰
          REPO_BIN_DIR="/home/runner/bin"
          mkdir -p "$REPO_BIN_DIR"
          
          # 2. å³æ—¶æ·»åŠ è·¯å¾„åˆ°å½“å‰ä¼šè¯PATHï¼ˆéäº¤äº’å¼shellæ— éœ€ä¾èµ–.bashrcï¼‰
          export PATH="$REPO_BIN_DIR:$PATH"
          echo "å½“å‰PATHï¼š$PATH"  # éªŒè¯è·¯å¾„å·²æ·»åŠ 
          
          # 3. ä¸‹è½½å®˜æ–¹æœ€æ–°repo launcher
          curl -fL https://storage.googleapis.com/git-repo-downloads/repo > "$REPO_BIN_DIR/repo"
          if [ $? -ne 0 ]; then
            echo "âŒ ä¸‹è½½repoå¤±è´¥ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥"
            exit 1
          fi
          
          # 4. è®¾ç½®å¯æ‰§è¡Œæƒé™å¹¶ä¿®å¤Pythonè¯­æ³•è­¦å‘Š
          chmod a+x "$REPO_BIN_DIR/repo"
          sed -i 's/import datetime/import datetime\nfrom datetime import UTC/' "$REPO_BIN_DIR/repo"
          sed -i 's/datetime.datetime.utcnow()/datetime.datetime.now(UTC)/g' "$REPO_BIN_DIR/repo"
          
          # 5. åˆ·æ–°å‘½ä»¤å“ˆå¸Œè¡¨+éªŒè¯å®‰è£…ï¼ˆç¡®ä¿ç³»ç»Ÿç«‹å³è¯†åˆ«repoï¼‰
          hash -r
          if command -v repo &> /dev/null; then
            echo "âœ… repoå®‰è£…æˆåŠŸ"
            echo "repoè·¯å¾„ï¼š$(which repo)"
            echo "repoç‰ˆæœ¬ï¼š$(repo --version | head -n1)"
          else
            echo "âŒ repoå‘½ä»¤ä»æœªæ‰¾åˆ°ï¼Œå®‰è£…å¤±è´¥"
            exit 1
          fi

      # 5. åŒæ­¥å†…æ ¸æºç ï¼ˆæ˜¾å¼å¯¼å‡ºPATHï¼Œé¿å…å­shellé—®é¢˜ï¼‰
      - name: ğŸ“¥ åŒæ­¥å†…æ ¸æºç 
        run: |
          # æ˜¾å¼å¯¼å‡ºrepoè·¯å¾„ï¼ˆç¡®ä¿å­shellèƒ½è¯†åˆ«ï¼‰
          export PATH="/home/runner/bin:$PATH"
          
          # åˆ›å»ºæºç ç›®å½•å¹¶åˆå§‹åŒ–repoï¼ˆåŒ¹é…showdo/kernel_manifestçš„åˆ†æ”¯å’Œxmlï¼‰
          mkdir -p kernel_workspace && cd kernel_workspace
          echo "åˆå§‹åŒ–repoï¼šåˆ†æ”¯=oneplus/sm8750ï¼Œé…ç½®æ–‡ä»¶=${REPO_MANIFEST}.xml"
          repo init -u https://github.com/showdo/kernel_manifest.git \
            -b refs/heads/oneplus/sm8750 \
            -m ${REPO_MANIFEST}.xml \
            --depth=1
          
          # åŒæ­¥æºç ï¼ˆå¢åŠ --no-clone-bundleæå‡å…¼å®¹æ€§ï¼Œå‡å°‘ç½‘ç»œé”™è¯¯ï¼‰
          echo "å¼€å§‹åŒæ­¥æºç ï¼Œçº¿ç¨‹æ•°=$(nproc)"
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          
          # éªŒè¯æºç åŒæ­¥ç»“æœ
          if [ -d "kernel_platform/common" ]; then
            echo "âœ… æºç åŒæ­¥å®Œæˆï¼Œæ ¸å¿ƒç›®å½•kernel_platform/commonå­˜åœ¨"
          else
            echo "âŒ æºç åŒæ­¥å¤±è´¥ï¼Œæœªæ‰¾åˆ°kernel_platform/commonç›®å½•"
            exit 1
          fi

      # 6. æ ¸å¿ƒï¼šç›‘æ§å¹¶ç”ŸæˆLZ4/ZSTDè¡¥ä¸ï¼ˆå«.sæ±‡ç¼–æ–‡ä»¶ï¼‰
      - name: ğŸ” ç›‘æ§å¹¶ç”ŸæˆLZ4/ZSTDè¡¥ä¸ï¼ˆå«æ±‡ç¼–æ–‡ä»¶ï¼‰
        run: |
          # å®šä¹‰å…³é”®è·¯å¾„ï¼ˆåŸºäºåŒæ­¥åçš„æºç ç»“æ„ï¼‰
          COMMON_DIR="kernel_workspace/kernel_platform/common"
          LZ4_DIR="$COMMON_DIR/lib/lz4"       # LZ4æ ¸å¿ƒç›®å½•
          ZSTD_DIR="$COMMON_DIR/lib/zstd"     # ZSTDæ ¸å¿ƒç›®å½•
          BACKUP_DIR="${GITHUB_WORKSPACE}/lz4_zstd_backup"  # åŸå§‹æ–‡ä»¶å¤‡ä»½
          PATCH_DIR="${GITHUB_WORKSPACE}/lz4_zstd_patches"  # æœ€ç»ˆè¡¥ä¸è¾“å‡º
          MONITOR_LOG="${GITHUB_WORKSPACE}/monitor_logs"     # ç›‘æ§æ—¥å¿—
          mkdir -p "$BACKUP_DIR" "$PATCH_DIR" "$MONITOR_LOG"

          # -------------------------- 1. å¤‡ä»½LZ4/ZSTDåŸå§‹æ–‡ä»¶ï¼ˆå«æ±‡ç¼–ï¼‰ --------------------------
          echo "ğŸ“‹ å¤‡ä»½LZ4/ZSTDåŸå§‹æ–‡ä»¶ï¼ˆå«.sæ±‡ç¼–æ–‡ä»¶ï¼‰"
          
          # å¤‡ä»½LZ4ç›¸å…³æ–‡ä»¶ï¼ˆè¦†ç›–.c/.h/.s/Makefile/.mkï¼‰
          find "$LZ4_DIR" -type f \( -name "*.c" -o -name "*.h" -o -name "*.s" -o -name "Makefile" -o -name "*.mk" \) | while read -r file; do
            rel_path="${file#$COMMON_DIR/}"  # ä¿ç•™ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚lib/lz4/lz4_asm.sï¼‰
            mkdir -p "$BACKUP_DIR/$(dirname "$rel_path")"
            cp "$file" "$BACKUP_DIR/$rel_path"
            echo "âœ… å¤‡ä»½LZ4æ–‡ä»¶ï¼š$rel_path"
          done
          
          # å¤‡ä»½ZSTDç›¸å…³æ–‡ä»¶ï¼ˆåŒLZ4è§„åˆ™ï¼‰
          find "$ZSTD_DIR" -type f \( -name "*.c" -o -name "*.h" -o -name "*.s" -o -name "Makefile" -o -name "*.mk" \) | while read -r file; do
            rel_path="${file#$COMMON_DIR/}"
            mkdir -p "$BACKUP_DIR/$(dirname "$rel_path")"
            cp "$file" "$BACKUP_DIR/$rel_path"
            echo "âœ… å¤‡ä»½ZSTDæ–‡ä»¶ï¼š$rel_path"
          done

          # -------------------------- 2. å¯åŠ¨å¤šç»´åº¦ç›‘æ§ï¼ˆèšç„¦LZ4/ZSTDï¼‰ --------------------------
          echo "ğŸ” å¯åŠ¨ç›‘æ§ï¼ˆä»…è·Ÿè¸ªLZ4/ZSTDç›®å½•ï¼‰"
          
          # 2.1 inotifyå®æ—¶ç›‘æ§ï¼ˆæ•è·åˆ›å»º/åˆ é™¤/ä¿®æ”¹/ç§»åŠ¨äº‹ä»¶ï¼‰
          INOTIFY_LOG="$MONITOR_LOG/inotify.log"
          inotifywait -m -r \
            --timefmt "%Y-%m-%d %H:%M:%S" \
            --format "%T %e %w%f" \
            -e create -e delete -e modify -e move \
            "$LZ4_DIR" "$ZSTD_DIR" > "$INOTIFY_LOG" 2>&1 &
          INOTIFY_PID=$!
          echo "inotifyç›‘æ§PIDï¼š$INOTIFY_PID"
          
          # 2.2 gitåŸºå‡†çŠ¶æ€è®°å½•ï¼ˆç”¨äºåç»­diffå¯¹æ¯”ï¼‰
          cd "$COMMON_DIR"
          git add -A  # æš‚å­˜æ‰€æœ‰æ–‡ä»¶
          git commit -m "Initial state before main.bin execution" || true  # å…è®¸ç©ºæäº¤
          INIT_COMMIT=$(git rev-parse HEAD)
          echo "gitåŸºå‡†æäº¤ï¼š$INIT_COMMIT"

          # -------------------------- 3. æ‰§è¡Œmain.binï¼ˆè§¦å‘LZ4ä¿®æ”¹ï¼‰ --------------------------
          echo "ğŸ”§ æ‰§è¡Œmain.binï¼ˆä»…å…³æ³¨LZ4/ZSTDä¿®æ”¹ï¼‰"
          cd "$COMMON_DIR"
          
          # 1. æ¸…ç†åŸæœ‰LZ4æ–‡ä»¶ï¼ˆæ¨¡æ‹ŸåŸå·¥ä½œæµé€»è¾‘ï¼‰
          rm -f lib/lz4/lz4_compress.c lib/lz4/lz4_decompress.c lib/lz4/lz4defs.h lib/lz4/lz4hc_compress.c
          
          # 2. å¤åˆ¶å¹¶æ‰§è¡ŒåŠ å¯†è„šæœ¬main.bin
          MAIN_BIN_PATH="${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin"
          if [ ! -f "$MAIN_BIN_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°main.binï¼Œè·¯å¾„ï¼š$MAIN_BIN_PATH"
            exit 1
          fi
          cp "$MAIN_BIN_PATH" ./
          chmod +x main.bin
          
          # 3. straceç›‘æ§ç³»ç»Ÿè°ƒç”¨ï¼ˆä»…è®°å½•æ–‡ä»¶æ“ä½œï¼‰
          STRACE_LOG="$MONITOR_LOG/strace.log"
          strace -f -e trace=file -o "$STRACE_LOG" ./main.bin "setup_lz4"
          
          # 4. åœæ­¢ç›‘æ§å¹¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          kill $INOTIFY_PID
          rm -f main.bin
          echo "âœ… main.binæ‰§è¡Œå®Œæˆï¼Œç›‘æ§å·²åœæ­¢"

          # -------------------------- 4. åˆ†æç›‘æ§ç»“æœï¼ˆæå–LZ4/ZSTDæ”¹åŠ¨ï¼‰ --------------------------
          echo "ğŸ“Š åˆ†æç›‘æ§ç»“æœï¼Œæå–LZ4/ZSTDæ”¹åŠ¨æ–‡ä»¶"
          
          # 4.1 ä»git diffæå–æ”¹åŠ¨ï¼ˆç²¾å‡†åˆ°æºç æ–‡ä»¶ï¼‰
          git diff "$INIT_COMMIT" --name-only | grep -E "^lib/lz4/|^lib/zstd/" > "$MONITOR_LOG/git_changed.txt"
          
          # 4.2 ä»inotifyæå–æ”¹åŠ¨ï¼ˆå®æ—¶æ–‡ä»¶äº‹ä»¶ï¼‰
          grep -E "$LZ4_DIR|$ZSTD_DIR" "$INOTIFY_LOG" | awk '{print $3}' | sed "s|$COMMON_DIR/||" >> "$MONITOR_LOG/inotify_changed.txt"
          
          # 4.3 ä»straceæå–æ”¹åŠ¨ï¼ˆç³»ç»Ÿè°ƒç”¨å±‚é¢ï¼‰
          grep -E "$LZ4_DIR|$ZSTD_DIR" "$STRACE_LOG" | awk -F'"' '{print $2}' | sed "s|$COMMON_DIR/||" >> "$MONITOR_LOG/strace_changed.txt"
          
          # 4.4 æ•´åˆå¹¶å»é‡ï¼ˆé¿å…é‡å¤è®°å½•ï¼‰
          cat "$MONITOR_LOG/git_changed.txt" "$MONITOR_LOG/inotify_changed.txt" "$MONITOR_LOG/strace_changed.txt" \
            | sort | uniq | grep -E "^lib/lz4/|^lib/zstd/" > "$MONITOR_LOG/all_changed.txt"
          
          # è¾“å‡ºæ”¹åŠ¨æ–‡ä»¶åˆ—è¡¨
          echo -e "\n=== æ£€æµ‹åˆ°çš„LZ4/ZSTDæ”¹åŠ¨æ–‡ä»¶ ==="
          if [ -s "$MONITOR_LOG/all_changed.txt" ]; then
            cat "$MONITOR_LOG/all_changed.txt"
          else
            echo "âš ï¸ æœªæ£€æµ‹åˆ°LZ4/ZSTDæ”¹åŠ¨æ–‡ä»¶"
          fi

          # -------------------------- 5. ç”Ÿæˆçº¯å‡€LZ4/ZSTDè¡¥ä¸ï¼ˆå«æ±‡ç¼–ï¼‰ --------------------------
          echo -e "\nğŸ”¨ ç”ŸæˆLZ4/ZSTDè¡¥ä¸ï¼ˆå«.sæ±‡ç¼–æ–‡ä»¶ï¼‰"
          
          while read -r file; do
            # åœºæ™¯1ï¼šæ–‡ä»¶è¢«ä¿®æ”¹ï¼ˆç”Ÿæˆdiffè¡¥ä¸ï¼‰
            if [ -f "$BACKUP_DIR/$file" ] && [ -f "$COMMON_DIR/$file" ]; then
              # ç”Ÿæˆè¡¥ä¸ï¼ˆ-uï¼šç»Ÿä¸€æ ¼å¼ï¼Œ-wï¼šå¿½ç•¥ç©ºç™½å·®å¼‚ï¼‰
              patch_filename="$(echo "$file" | tr '/' '_').patch"
              diff -u -w "$BACKUP_DIR/$file" "$COMMON_DIR/$file" > "$PATCH_DIR/$patch_filename"
              
              # è¿‡æ»¤ç©ºè¡¥ä¸ï¼ˆæ— å®é™…æ”¹åŠ¨çš„æ–‡ä»¶ï¼‰
              if [ -s "$PATCH_DIR/$patch_filename" ]; then
                echo "âœ… ç”Ÿæˆè¡¥ä¸ï¼š$file â†’ $patch_filename"
              else
                rm "$PATCH_DIR/$patch_filename"
                echo "âš ï¸ è·³è¿‡ç©ºè¡¥ä¸ï¼š$file"
              fi
              
            # åœºæ™¯2ï¼šæ–‡ä»¶æ–°å¢ï¼ˆç›´æ¥ä¿å­˜å®Œæ•´æ–‡ä»¶ï¼‰
            elif [ ! -f "$BACKUP_DIR/$file" ] && [ -f "$COMMON_DIR/$file" ]; then
              new_file_path="$PATCH_DIR/$file"
              mkdir -p "$(dirname "$new_file_path")"
              cp "$COMMON_DIR/$file" "$new_file_path"
              echo "âœ… ä¿å­˜æ–°å¢æ–‡ä»¶ï¼š$file"
            fi
          done < "$MONITOR_LOG/all_changed.txt"

          # éªŒè¯è¡¥ä¸ç”Ÿæˆç»“æœ
          echo -e "\n=== è¡¥ä¸ç”Ÿæˆæ€»ç»“ ==="
          if [ -n "$(ls -A "$PATCH_DIR" 2>/dev/null)" ]; then
            echo "âœ… è¡¥ä¸ç”Ÿæˆå®Œæˆï¼Œå…±$(ls -1 "$PATCH_DIR" | wc -l)ä¸ªæ–‡ä»¶"
            echo "è¡¥ä¸ç›®å½•ï¼š$PATCH_DIR"
            ls -1 "$PATCH_DIR"
          else
            echo "âš ï¸ æœªç”Ÿæˆä»»ä½•è¡¥ä¸ï¼ˆå¯èƒ½main.binæœªä¿®æ”¹LZ4/ZSTDï¼‰"
          fi

      # 7. ä¸Šä¼ äº§ç‰©ï¼ˆè¡¥ä¸+ç›‘æ§æ—¥å¿—ï¼‰
      - name: ğŸ“¤ ä¸Šä¼ LZ4/ZSTDè¡¥ä¸åŠç›‘æ§æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: lz4_zstd_patches_with_asm_${{ env.DEVICES_NAME }}
          path: |
            ./lz4_zstd_patches/**/*        # æ ¸å¿ƒï¼šLZ4/ZSTDè¡¥ä¸ï¼ˆå«æ±‡ç¼–ï¼‰
            ./lz4_zstd_backup/**/*         # åŸå§‹æ–‡ä»¶å¤‡ä»½ï¼ˆå¯¹æ¯”ç”¨ï¼‰
            ./monitor_logs/**/*            # ç›‘æ§æ—¥å¿—ï¼ˆé—®é¢˜æ’æŸ¥ç”¨ï¼‰
          retention-days: 365  # é•¿æœŸä¿ç•™ï¼Œä¾¿äºåç»­ç§»æ¤å’Œæ’æŸ¥
