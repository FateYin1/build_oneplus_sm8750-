name: LZ4_ZSTD_Patch_Capture_Only
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "ğŸ“é€‰æ‹©æœºå‹"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_13'


jobs:
  capture_patch:
    name: Capture_LZ4_ZSTD_Patch_${{ github.event.inputs.REPO_MANIFEST }}
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»“åº“ä»£ç 
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. æ£€æŸ¥ç£ç›˜ç©ºé—´
      - name: ğŸ“Š Check disk space
        run: |
          echo "æ„å»ºå‰ç£ç›˜ç©ºé—´ï¼š"
          df -h

      # 3. è®¾ç½®æœºå‹ç¯å¢ƒå˜é‡
      - name: âš™ï¸ Set REPO_MANIFEST & DEVICES_NAME
        run: |
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_ace5_pro)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_ace5_pro_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_ace5_pro" >> $GITHUB_ENV
              ;;
            oneplus_13)
              echo "REPO_MANIFEST=JiuGeFaCai_oneplus_13_v" >> $GITHUB_ENV
              echo "DEVICES_NAME=oneplus_13" >> $GITHUB_ENV
              ;;
            *)
              echo "REPO_MANIFEST=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              echo "DEVICES_NAME=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV
              ;;
          esac
          echo 'KERNEL_TIME=Mon May 12 09:09:59 UTC 2025' >> $GITHUB_ENV

      # 4. é…ç½®Gitè´¦æˆ·
      - name: ğŸ“¦ Configure Git
        run: |
          git config --global user.name "FateYin1"
          git config --global user.email "1244243922@qq.com"

      # 5. é…ç½®APTç¼“å­˜å¹¶å®‰è£…ä¾èµ–
      - name: ğŸ›  Configure APT & Install dependencies
        run: |
          APT_CACHE_DIR="$HOME/apt-cache"
          mkdir -p "$APT_CACHE_DIR"/{archives,lists/partial}
          echo "Dir::Cache \"$APT_CACHE_DIR\";" | sudo tee /etc/apt/apt.conf.d/90user-cache
          echo "Dir::Cache::archives \"$APT_CACHE_DIR/archives\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          sudo chown -R $USER:$USER "$APT_CACHE_DIR"

          sudo rm -f /var/lib/apt/lists/lock /var/lib/dpkg/lock
          sudo apt -o Dir::Cache="$APT_CACHE_DIR" update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt -o Dir::Cache="$APT_CACHE_DIR" install -yq --no-install-recommends \
            python3 git curl libelf-dev \
            build-essential flex bison libssl-dev \
            liblz4-tool zlib1g-dev rsync unzip coreutils

      # 6. å®‰è£…å¹¶ä¿®å¤repoå·¥å…·
      - name: ğŸ“¥ Install & Fix repo tool
        run: |
          sudo apt remove -y repo || true
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo
          sudo sed -i 's/import datetime/import datetime\nfrom datetime import UTC/' /usr/local/bin/repo
          sudo sed -i 's/datetime.datetime.utcnow()/datetime.datetime.now(UTC)/g' /usr/local/bin/repo
          echo "repoè·¯å¾„ï¼š$(which repo)"
          echo "repoç‰ˆæœ¬ï¼š$(repo --version | head -n1)"

      # 7. åŒæ­¥å†…æ ¸æºç 
      - name: ğŸ“¥ Sync kernel source
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/showdo/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m ${REPO_MANIFEST}.xml --depth=1
          repo --trace sync -c -j$(nproc --all) --no-tags
          rm kernel_platform/common/android/abi_gki_protected_exports_* || echo "No protected exports!"
          rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* || echo "No protected exports!"
          if [ ! -d "kernel_platform/common/lib/lz4" ]; then
            echo "::error ::LZ4æ ¸å¿ƒç›®å½•ä¸å­˜åœ¨: kernel_platform/common/lib/lz4"
            exit 1
          fi
          echo "=== åŒæ­¥ååŸå§‹LZ4ç›®å½•å†…å®¹ ==="
          ls -la "kernel_platform/common/lib/lz4"

      # 8. é…ç½®SuKiSU Ultra
      - name: âš™ï¸ Set SuKiSU Ultra
        run: |
          mkdir -p kernel_workspace/kernel_platform
          cd kernel_workspace/kernel_platform
          
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/setup.sh" -o setup.sh && bash setup.sh susfs-main
          cd KernelSU
          KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 10700)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/setup.bin" ./
          chmod +x setup.bin
          if [ ! -f "kernel/Makefile" ]; then
            echo "::error ::kernel/Makefileä¸å­˜åœ¨"
            exit 1
          fi
          ./setup.bin

      # 9. æ›¿æ¢SuKiSUç‰ˆæœ¬æ ‡è¯†
      - name: ğŸ›  Replace SuKiSU version tag
        run: |
          cd kernel_workspace/kernel_platform
          TARGET_FILES=$(grep -rl "TG@qdykernel" . || true)
          if [ -n "$TARGET_FILES" ]; then
            sed -i 's/TG@qdykernel/é…·å®‰Fate007/g' $TARGET_FILES
            echo "âœ… ç‰ˆæœ¬æ ‡è¯†æ›¿æ¢å®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç›®æ ‡æ ‡è¯†æ–‡ä»¶"
          fi

      # 10. å¤‡ä»½LZ4/ZSTDåŸå§‹æ–‡ä»¶
      - name: ğŸ“‹ Backup original LZ4/ZSTD files
        run: |
          COMMON_DIR="kernel_workspace/kernel_platform/common"
          LZ4_DIR="$COMMON_DIR/lib/lz4"
          ZSTD_DIR=$(find "$COMMON_DIR" -type d -name "zstd" | grep -E "(lib|compression)/zstd" | head -1 || true)
          
          BACKUP_DIR="${GITHUB_WORKSPACE}/lz4_zstd_original_backup"
          mkdir -p "$BACKUP_DIR"
          
          echo "âœ… å¤‡ä»½LZ4ç›®å½•ï¼š$LZ4_DIR"
          mkdir -p "$BACKUP_DIR/lib"
          if [ ! -d "$LZ4_DIR" ]; then
            echo "::error ::å¤‡ä»½å¤±è´¥ï¼ŒæºLZ4ç›®å½•ä¸å­˜åœ¨: $LZ4_DIR"
            exit 1
          fi
          cp -r "$LZ4_DIR" "$BACKUP_DIR/lib/lz4"
          if [ ! -d "$BACKUP_DIR/lib/lz4" ]; then
            echo "::error ::LZ4å¤‡ä»½å¤±è´¥ï¼Œç›®æ ‡ç›®å½•æœªåˆ›å»º"
            exit 1
          fi
          echo "=== LZ4å¤‡ä»½ç›®å½•å†…å®¹ ==="
          ls -la "$BACKUP_DIR/lib/lz4"
          
          if [ -n "$ZSTD_DIR" ] && [ -d "$ZSTD_DIR" ]; then
            ZSTD_REL_PATH="${ZSTD_DIR#$COMMON_DIR/}"
            echo "âœ… å¤‡ä»½ZSTDç›®å½•ï¼š$ZSTD_DIR"
            mkdir -p "$BACKUP_DIR/$(dirname "$ZSTD_REL_PATH")"
            cp -r "$ZSTD_DIR" "$BACKUP_DIR/$ZSTD_REL_PATH"
            if [ -d "$BACKUP_DIR/$ZSTD_REL_PATH" ]; then
              echo "=== ZSTDå¤‡ä»½ç›®å½•å†…å®¹ ==="
              ls -la "$BACKUP_DIR/$ZSTD_REL_PATH"
            else
              echo "âš ï¸ ZSTDå¤‡ä»½å¤±è´¥"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ZSTDç›®å½•ï¼Œè·³è¿‡å¤‡ä»½"
          fi

      # 11. é…ç½®SUSFS & æ‰§è¡Œmain.binä¿®æ”¹LZ4
      - name: ğŸ”§ Set up SUSFS & run main.bin
        run: |
          cd kernel_workspace
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android15-6.6
          git clone https://github.com/SukiSU-Ultra/SukiSU_patch.git
          
          cd kernel_platform
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android15-6.6.patch ./common/
          cp ../susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./common/include/linux
          cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./common/lib
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./common/crypto
          cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./common/lib/
          
          cd ./common
          if [ "$DEVICES_NAME" != "oneplus_ace5_ultra" ] && [ "${REPO_MANIFEST}" != "realme_GT7" ]; then
            files=(
              "lib/lz4/lz4_compress.c"
              "lib/lz4/lz4_decompress.c"
              "lib/lz4/lz4defs.h"
              "lib/lz4/lz4hc_compress.c"
            )
            for file in "${files[@]}"; do
              if [ -e "$file" ]; then
                rm "$file"
                echo "å·²åˆ é™¤æ—§æ–‡ä»¶: $file"
              fi
            done
            if [ ! -f "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ]; then
              echo "::error ::main.binä¸å­˜åœ¨"
              exit 1
            fi
            cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ./
            chmod +x main.bin
            ./main.bin "setup_lz4"
            rm -rf ./main.bin
            echo "âœ… main.binæ‰§è¡Œå®Œæˆï¼ŒLZ4å·²ä¿®æ”¹"
            echo "=== ä¿®æ”¹åLZ4ç›®å½•å†…å®¹ ==="
            ls -la "lib/lz4" || echo "ä¿®æ”¹åLZ4ç›®å½•ä¸å­˜åœ¨"
            if [ ! -d "lib/lz4" ]; then
              echo "::error ::main.binæ‰§è¡ŒåLZ4ç›®å½•ä¸¢å¤±"
              exit 1
            fi
          fi

      # 12. ç”ŸæˆLZ4/ZSTDè¡¥ä¸ï¼ˆå®Œæ•´ä¿®å¤commæ’åºé—®é¢˜ï¼‰
      - name: ğŸ”¨ Generate LZ4/ZSTD patches (final)
        run: |
          COMMON_DIR="kernel_workspace/kernel_platform/common"
          LZ4_DIR="$COMMON_DIR/lib/lz4"
          BACKUP_DIR="${GITHUB_WORKSPACE}/lz4_zstd_original_backup"
          PATCH_DIR="${GITHUB_WORKSPACE}/final_lz4_zstd_patches"
          mkdir -p "$PATCH_DIR"

          echo "=== è¡¥ä¸ç”Ÿæˆç¯å¢ƒä¿¡æ¯ ==="
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "COMMON_DIR: $COMMON_DIR"
          echo "LZ4_DIR: $LZ4_DIR"
          echo "BACKUP_DIR: $BACKUP_DIR"
          echo "BACKUP LZ4è·¯å¾„: $BACKUP_DIR/lib/lz4"
          echo "PATCH_DIR: $PATCH_DIR"

          # 1. è¯†åˆ«æ–°å¢æ–‡ä»¶ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶æ’åºæ–‡ä»¶åˆ—è¡¨ï¼‰
          echo -e "\n=== è¯†åˆ«æ–°å¢æ–‡ä»¶ ==="
          # ç”Ÿæˆå¹¶æ’åºæºæ–‡ä»¶åˆ—è¡¨
          find "$LZ4_DIR" -type f | sed "s|^$LZ4_DIR/||" | sort > "$PATCH_DIR/source_files.txt"
          # ç”Ÿæˆå¹¶æ’åºå¤‡ä»½æ–‡ä»¶åˆ—è¡¨
          find "$BACKUP_DIR/lib/lz4" -type f | sed "s|^$BACKUP_DIR/lib/lz4/||" | sort > "$PATCH_DIR/backup_files.txt"
          
          # éªŒè¯æ’åºç»“æœ
          echo "æºæ–‡ä»¶åˆ—è¡¨å‰5è¡Œï¼ˆå·²æ’åºï¼‰:"
          head -n 5 "$PATCH_DIR/source_files.txt"
          echo "å¤‡ä»½æ–‡ä»¶åˆ—è¡¨å‰5è¡Œï¼ˆå·²æ’åºï¼‰:"
          head -n 5 "$PATCH_DIR/backup_files.txt"
          
          # ä½¿ç”¨æ’åºåçš„æ–‡ä»¶æ‰§è¡Œcommå‘½ä»¤
          NEW_FILES=$(comm -23 "$PATCH_DIR/source_files.txt" "$PATCH_DIR/backup_files.txt")
          
          if [ -n "$NEW_FILES" ]; then
            echo "æ£€æµ‹åˆ°æ–°å¢æ–‡ä»¶ï¼Œå…± $(echo "$NEW_FILES" | wc -l) ä¸ª:"
            echo "$NEW_FILES"
            for file in $NEW_FILES; do
              empty_file="$BACKUP_DIR/lib/lz4/$file"
              mkdir -p "$(dirname "$empty_file")"
              touch "$empty_file"
              echo "  å·²åˆ›å»ºç©ºå¤‡ä»½æ–‡ä»¶: $empty_file"
            done
          else
            echo "æœªæ£€æµ‹åˆ°æ–°å¢æ–‡ä»¶"
          fi

          # 2. å¤„ç†ç¬¦å·é“¾æ¥
          echo -e "\n=== å¤„ç†ç¬¦å·é“¾æ¥ ==="
          for link in $(find "$LZ4_DIR" -type l); do
            echo "å‘ç°ç¬¦å·é“¾æ¥: $linkï¼Œæ›¿æ¢ä¸ºå®é™…æ–‡ä»¶"
            target=$(readlink "$link")
            rm "$link"
            cp "$target" "$link"
          done
          for link in $(find "$BACKUP_DIR/lib/lz4" -type l); do
            echo "å‘ç°å¤‡ä»½ç¬¦å·é“¾æ¥: $linkï¼Œæ›¿æ¢ä¸ºå®é™…æ–‡ä»¶"
            target=$(readlink "$link")
            rm "$link"
            cp "$target" "$link"
          done

          # 3. è¯†åˆ«å¹¶æ’é™¤äºŒè¿›åˆ¶æ–‡ä»¶
          echo -e "\n=== è¯†åˆ«äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          BINARY_FILES=$(find "$LZ4_DIR" -type f ! -name "*.c" ! -name "*.h" ! -name "*.s" ! -name "Makefile" ! -name "Kconfig")
          if [ -n "$BINARY_FILES" ]; then
            echo "æ£€æµ‹åˆ°éæ–‡æœ¬æ–‡ä»¶ï¼Œå°†æ’é™¤ä»¥ä¸‹æ–‡ä»¶:"
            echo "$BINARY_FILES"
            EXCLUDE_PARAMS=$(echo "$BINARY_FILES" | xargs -n1 basename | sed 's/^/--exclude=/')
          else
            echo "æœªæ£€æµ‹åˆ°éæ–‡æœ¬æ–‡ä»¶ï¼Œæ— éœ€æ’é™¤"
            EXCLUDE_PARAMS=""
          fi

          # 4. åˆ†æ–‡ä»¶å¯¹æ¯”æ£€æµ‹
          echo -e "\n=== åˆ†æ–‡ä»¶å¯¹æ¯”æ£€æµ‹ ==="
          FAIL_FILES=""
          for file in $(find "$LZ4_DIR" -type f); do
            rel_path="${file#$LZ4_DIR/}"
            backup_file="$BACKUP_DIR/lib/lz4/$rel_path"
            if [ -f "$backup_file" ]; then
              echo "å¯¹æ¯”æ–‡ä»¶: $rel_path"
              if ! diff -u "$backup_file" "$file" > /dev/null 2>&1; then
                echo "  å­˜åœ¨å·®å¼‚"
              fi
            else
              echo "  å¤‡ä»½æ–‡ä»¶ç¼ºå¤±: $rel_path"
              FAIL_FILES="$FAIL_FILES $rel_path"
            fi
          done
          if [ -n "$FAIL_FILES" ]; then
            echo "âš ï¸ å­˜åœ¨ç¼ºå¤±çš„å¤‡ä»½æ–‡ä»¶: $FAIL_FILES"
          fi

          # 5. ç”ŸæˆLZ4è¡¥ä¸
          echo -e "\n=== ç”ŸæˆLZ4è¡¥ä¸ ==="
          if diff -urN $EXCLUDE_PARAMS --binary "$BACKUP_DIR/lib/lz4" "$LZ4_DIR" > "$PATCH_DIR/lz4_patch_with_asm.patch"; then
            echo "âœ… diffå‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
          else
            if [ $? -eq 1 ]; then
              echo "âš ï¸ diffè¿”å›1ï¼ˆå­˜åœ¨å·®å¼‚ï¼Œå·²ç”Ÿæˆè¡¥ä¸ï¼‰"
            else
              echo "âŒ diffå‘½ä»¤å¤±è´¥ï¼ˆé”™è¯¯ä»£ç : $?ï¼‰"
              exit 1
            fi
          fi

          # 6. éªŒè¯è¡¥ä¸å†…å®¹
          if [ -s "$PATCH_DIR/lz4_patch_with_asm.patch" ]; then
            echo "âœ… LZ4è¡¥ä¸ç”ŸæˆæˆåŠŸï¼Œå¤§å°: $(du -sh "$PATCH_DIR/lz4_patch_with_asm.patch" | awk '{print $1}')"
            if [ -n "$NEW_FILES" ]; then
              echo "éªŒè¯æ–°å¢æ–‡ä»¶æ˜¯å¦åœ¨è¡¥ä¸ä¸­:"
              for file in $NEW_FILES; do
                if grep -q "+++ $LZ4_DIR/$file" "$PATCH_DIR/lz4_patch_with_asm.patch"; then
                  echo "  âœ… æ–°å¢æ–‡ä»¶å·²åŒ…å«: $file"
                else
                  echo "  âš ï¸ æ–°å¢æ–‡ä»¶æœªåŒ…å«: $file"
                fi
              done
            fi
            echo "è¡¥ä¸å‰10è¡Œé¢„è§ˆ:"
            head -n 10 "$PATCH_DIR/lz4_patch_with_asm.patch"
          else
            rm "$PATCH_DIR/lz4_patch_with_asm.patch"
            echo "âš ï¸ LZ4è¡¥ä¸ä¸ºç©ºï¼ˆæ— æ”¹åŠ¨ï¼‰"
          fi

          # 7. ç”ŸæˆZSTDè¡¥ä¸ï¼ˆåŒæ ·ä¿®å¤æ’åºé—®é¢˜ï¼‰
          echo -e "\n=== ç”ŸæˆZSTDè¡¥ä¸ ==="
          ZSTD_DIR=$(find "$COMMON_DIR" -type d -name "zstd" | grep -E "(lib|compression)/zstd" | head -1 || true)
          if [ -n "$ZSTD_DIR" ] && [ -d "$ZSTD_DIR" ] && [ -d "$BACKUP_DIR/$(basename "$ZSTD_DIR")" ]; then
            ZSTD_REL_PATH="${ZSTD_DIR#$COMMON_DIR/}"
            echo "ZSTDæºç›®å½•: $ZSTD_DIR"
            echo "ZSTDå¤‡ä»½ç›®å½•: $BACKUP_DIR/$ZSTD_REL_PATH"
            
            # ZSTDæ–°å¢æ–‡ä»¶æ£€æµ‹ï¼ˆæ’åºåå¯¹æ¯”ï¼‰
            find "$ZSTD_DIR" -type f | sed "s|^$ZSTD_DIR/||" | sort > "$PATCH_DIR/zstd_source_files.txt"
            find "$BACKUP_DIR/$ZSTD_REL_PATH" -type f | sed "s|^$BACKUP_DIR/$ZSTD_REL_PATH/||" | sort > "$PATCH_DIR/zstd_backup_files.txt"
            ZSTD_NEW_FILES=$(comm -23 "$PATCH_DIR/zstd_source_files.txt" "$PATCH_DIR/zstd_backup_files.txt")
            
            if [ -n "$ZSTD_NEW_FILES" ]; then
              echo "ZSTDæ£€æµ‹åˆ°æ–°å¢æ–‡ä»¶: $(echo "$ZSTD_NEW_FILES" | wc -l) ä¸ª"
              for file in $ZSTD_NEW_FILES; do
                empty_file="$BACKUP_DIR/$ZSTD_REL_PATH/$file"
                mkdir -p "$(dirname "$empty_file")"
                touch "$empty_file"
              done
            fi
            
            # ç”ŸæˆZSTDè¡¥ä¸
            diff -urN --binary "$BACKUP_DIR/$ZSTD_REL_PATH" "$ZSTD_DIR" > "$PATCH_DIR/zstd_patch_with_asm.patch"
            if [ -s "$PATCH_DIR/zstd_patch_with_asm.patch" ]; then
              echo "âœ… ZSTDè¡¥ä¸ç”ŸæˆæˆåŠŸ"
            else
              rm "$PATCH_DIR/zstd_patch_with_asm.patch"
              echo "âš ï¸ ZSTDæ— å®é™…æ”¹åŠ¨ï¼Œå·²åˆ é™¤ç©ºè¡¥ä¸"
            fi
          else
            echo "âš ï¸ ZSTDç›®å½•ç¼ºå¤±æˆ–æœªæ”¹åŠ¨ï¼Œè·³è¿‡è¡¥ä¸ç”Ÿæˆ"
            echo "æ£€æµ‹åˆ°çš„ZSTD_DIR: $ZSTD_DIR"
          fi

      # 13. ä¸Šä¼ æœ€ç»ˆè¡¥ä¸äº§ç‰©
      - name: ğŸ“¤ Upload LZ4/ZSTD patches
        uses: actions/upload-artifact@v4
        with:
          name: LZ4_ZSTD_Patches_${{ env.DEVICES_NAME }}
          path: |
            ./final_lz4_zstd_patches/*
            ./lz4_zstd_original_backup/*
          retention-days: 1
