name: LZ4_ZSTD_Patch_Capture_Only
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "ğŸ“é€‰æ‹©æœºå‹"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_13'


jobs:
  capture_patch:
    name: Capture_LZ4_ZSTD_Patch_${{ github.event.inputs.REPO_MANIFEST }}
    runs-on: ubuntu-latest
    steps:
      # çœç•¥å‰é¢ç›¸åŒçš„æ­¥éª¤ï¼ˆæ£€å‡ºä»£ç ã€è®¾ç½®ç¯å¢ƒå˜é‡ã€å®‰è£…ä¾èµ–ç­‰ï¼‰
      # ...

      # 11. é…ç½®SUSFS & æ‰§è¡Œmain.binä¿®æ”¹LZ4ï¼ˆä¿æŒä¸å˜ï¼‰
      - name: ğŸ”§ Set up SUSFS & run main.bin
        run: |
          cd kernel_workspace
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android15-6.6
          git clone https://github.com/SukiSU-Ultra/SukiSU_patch.git
          
          cd kernel_platform
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android15-6.6.patch ./common/
          cp ../susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./common/include/linux
          cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./common/lib
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./common/crypto
          cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./common/lib/
          
          cd ./common
          if [ "$DEVICES_NAME" != "oneplus_ace5_ultra" ] && [ "${REPO_MANIFEST}" != "realme_GT7" ]; then
            files=(
              "lib/lz4/lz4_compress.c"
              "lib/lz4/lz4_decompress.c"
              "lib/lz4/lz4defs.h"
              "lib/lz4/lz4hc_compress.c"
            )
            for file in "${files[@]}"; do
              if [ -e "$file" ]; then
                rm "$file"
              fi
            done
            cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ./
            chmod +x main.bin
            ./main.bin "setup_lz4"
            rm -rf ./main.bin
            echo "âœ… main.binæ‰§è¡Œå®Œæˆï¼ŒLZ4å·²ä¿®æ”¹"
            # æ–°å¢ï¼šæ‰“å°ä¿®æ”¹åçš„LZ4ç›®å½•å†…å®¹ï¼ˆè°ƒè¯•ç”¨ï¼‰
            echo "=== ä¿®æ”¹åLZ4ç›®å½•æ–‡ä»¶åˆ—è¡¨ ==="
            ls -la "lib/lz4" || echo "ä¿®æ”¹åLZ4ç›®å½•ä¸å­˜åœ¨"
          fi

      # 12. ç”ŸæˆLZ4/ZSTDè¡¥ä¸ï¼ˆæ·»åŠ è°ƒè¯•å’Œå®¹é”™ï¼‰
      - name: ğŸ”¨ Generate LZ4/ZSTD patches (with debug)
        run: |
          # å®šä¹‰è·¯å¾„å˜é‡
          COMMON_DIR="kernel_workspace/kernel_platform/common"
          LZ4_DIR="$COMMON_DIR/lib/lz4"
          BACKUP_DIR="${GITHUB_WORKSPACE}/lz4_zstd_original_backup"
          PATCH_DIR="${GITHUB_WORKSPACE}/final_lz4_zstd_patches"
          mkdir -p "$PATCH_DIR"

          # æ–°å¢ï¼šæ‰“å°å…³é”®è·¯å¾„å˜é‡ï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo "=== è¡¥ä¸ç”Ÿæˆå…³é”®è·¯å¾„ ==="
          echo "COMMON_DIR: $COMMON_DIR"
          echo "LZ4_DIR: $LZ4_DIR"
          echo "BACKUP_DIR: $BACKUP_DIR"
          echo "BACKUP LZ4è·¯å¾„: $BACKUP_DIR/lib/lz4"

          # æ–°å¢ï¼šæ£€æŸ¥å¤‡ä»½ç›®å½•å’Œä¿®æ”¹åç›®å½•æ˜¯å¦å­˜åœ¨
          echo -e "\n=== ç›®å½•å­˜åœ¨æ€§æ£€æŸ¥ ==="
          if [ ! -d "$LZ4_DIR" ]; then
            echo "âŒ é”™è¯¯ï¼šä¿®æ”¹åçš„LZ4ç›®å½•ä¸å­˜åœ¨ - $LZ4_DIR"
            exit 1
          else
            echo "âœ… ä¿®æ”¹åçš„LZ4ç›®å½•å­˜åœ¨"
            # æ‰“å°ä¿®æ”¹åç›®å½•çš„æ–‡ä»¶ï¼ˆç¡®è®¤å†…å®¹ï¼‰
            echo "ä¿®æ”¹åLZ4ç›®å½•å†…å®¹ï¼š"
            ls -la "$LZ4_DIR"
          fi

          if [ ! -d "$BACKUP_DIR/lib/lz4" ]; then
            echo "âŒ é”™è¯¯ï¼šå¤‡ä»½çš„LZ4ç›®å½•ä¸å­˜åœ¨ - $BACKUP_DIR/lib/lz4"
            exit 1
          else
            echo "âœ… å¤‡ä»½çš„LZ4ç›®å½•å­˜åœ¨"
            # æ‰“å°å¤‡ä»½ç›®å½•çš„æ–‡ä»¶ï¼ˆç¡®è®¤å†…å®¹ï¼‰
            echo "å¤‡ä»½çš„LZ4ç›®å½•å†…å®¹ï¼š"
            ls -la "$BACKUP_DIR/lib/lz4"
          fi

          # ç”ŸæˆLZ4è¡¥ä¸ï¼ˆå¸¦è¯¦ç»†è¾“å‡ºï¼‰
          echo -e "\n=== ç”ŸæˆLZ4è¡¥ä¸ ==="
          # ä½¿ç”¨diffçš„--debugé€‰é¡¹è¾“å‡ºè¯¦ç»†å¯¹æ¯”è¿‡ç¨‹ï¼ˆä»…è°ƒè¯•ç”¨ï¼Œå¯æ³¨é‡Šï¼‰
          diff -urN --debug "$BACKUP_DIR/lib/lz4" "$LZ4_DIR" > "$PATCH_DIR/lz4_patch_with_asm.patch"
          
          # æ£€æŸ¥è¡¥ä¸ç”Ÿæˆç»“æœ
          if [ $? -eq 0 ]; then
            echo "âœ… diffå‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
            if [ -s "$PATCH_DIR/lz4_patch_with_asm.patch" ]; then
              echo "âœ… LZ4è¡¥ä¸ç”ŸæˆæˆåŠŸï¼ˆéç©ºï¼‰"
              # æ‰“å°è¡¥ä¸å‰10è¡Œï¼ˆç¡®è®¤å†…å®¹ï¼‰
              echo "è¡¥ä¸å‰10è¡Œï¼š"
              head -n 10 "$PATCH_DIR/lz4_patch_with_asm.patch"
            else
              rm "$PATCH_DIR/lz4_patch_with_asm.patch"
              echo "âš ï¸ LZ4æ— å®é™…æ”¹åŠ¨ï¼Œå·²åˆ é™¤ç©ºè¡¥ä¸"
            fi
          else
            echo "âŒ diffå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼ˆè¿”å›å€¼é0ï¼‰"
            # è¾“å‡ºdiffçš„é”™è¯¯æ—¥å¿—ï¼ˆå¦‚æœæœ‰ï¼‰
            echo "diffé”™è¯¯è¾“å‡ºï¼š"
            cat "$PATCH_DIR/lz4_patch_with_asm.patch" 2>/dev/null
            exit 1
          fi

          # ç”ŸæˆZSTDè¡¥ä¸ï¼ˆä¿æŒç±»ä¼¼é€»è¾‘ï¼Œçœç•¥é‡å¤éƒ¨åˆ†ï¼‰
          # ...

      # 13. ä¸Šä¼ æœ€ç»ˆè¡¥ä¸äº§ç‰©ï¼ˆä¿æŒä¸å˜ï¼‰
      - name: ğŸ“¤ Upload LZ4/ZSTD patches
        uses: actions/upload-artifact@v4
        with:
          name: LZ4_ZSTD_Patches_${{ env.DEVICES_NAME }}
          path: |
            ./final_lz4_zstd_patches/*
            ./lz4_zstd_original_backup/*
          retention-days: 365
